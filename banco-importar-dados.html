<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGEF | Importar Dados - Caruaru</title>
  <link rel="icon" type="image/png" href="img/brasao-caruaru.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/portal-transparencia.css">
  <!-- SheetJS para ler Excel -->
    <script src="js/auth-check.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Pipeline de transforma√ß√£o (para importa√ß√£o de planilhas brutas) -->
  <script src="pipeline-dados/js/utils-transformacao.js?v=20260208"></script>
  <script src="pipeline-dados/js/transformar-credores.js?v=20260208"></script>
  <script src="pipeline-dados/js/transformar-a-pagar.js?v=20260208"></script>
  <script src="pipeline-dados/js/transformar-pagos.js?v=20260208"></script>
  <script src="pipeline-dados/js/transformar-emitidos.js?v=20260208"></script>
  <script src="pipeline-dados/js/transformar-liquidados.js?v=20260208"></script>
  <script src="pipeline-dados/js/transformar-consignados.js?v=20260208"></script>
  <script src="pipeline-dados/js/transformar-detalhamento.js?v=20260208"></script>
  <script src="pipeline-dados/js/cruzar-dados.js?v=20260208"></script>
  <!-- V2: Substituir alvos para usar consignados em vez de retidos -->
  <script>
    _CRUZAR_ALVOS = [
      { role: 'liquidados', label: 'Emp. Liquidados', gruposFortes: [['liquidados']], palavras: ['relacao','empenhos','liquidados','movimento','mensal','completo','final'], obrigatorio: true },
      { role: 'pagos', label: 'Emp. Pagos', gruposFortes: [['pagos','sintetico'],['empenhos','pagos']], palavras: ['empenhos','pagos','sintetico','relacao'], obrigatorio: true },
      { role: 'emitidos', label: 'Emp. Emitidos', gruposFortes: [['empenhos','emitidos']], palavras: ['empenhos','emitidos','relacao','mensal'], obrigatorio: true },
      { role: 'aPagar', label: 'Empenhos a pagar', gruposFortes: [['empenhos','pagar']], palavras: ['relacao','empenhos','pagar','a'], obrigatorio: true },
      { role: 'consignados', label: 'Consignados Anal√≠tico', gruposFortes: [['retidos','consignados'],['consignados','analitico']], palavras: ['retidos','consignados','analitico','movimento','consignacoes'], obrigatorio: true },
      { role: 'credores', label: 'Credores', gruposFortes: [['credores'],['fornecedores']], palavras: ['relacao','credores','fornecedores','credor'], obrigatorio: true },
      { role: 'simples', label: 'Simples Nacional (opcional)', gruposFortes: [['simples','nacional'],['simples']], palavras: ['simples','nacional','resultado','planilha'], obrigatorio: false },
      { role: 'balancete', label: 'Balancete', gruposFortes: [['balancete','despesa'],['balancete']], palavras: ['balancete','despesa'], obrigatorio: true },
      { role: 'detalhamento', label: 'Detalhamento', gruposFortes: [['natureza','consolidado'],['despesa','natureza']], palavras: ['relatorio','despesa','natureza','consolidado'], obrigatorio: true }
    ];
  </script>
  <style>
    .upload-area {
      border: 3px dashed #e2e8f0;
      border-radius: 16px;
      padding: 60px 40px;
      text-align: center;
      background: #f8fafc;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 30px;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: var(--color-primary);
      background: rgba(45, 152, 70, 0.05);
    }
    .upload-area i {
      font-size: 64px;
      color: #cbd5e1;
      margin-bottom: 20px;
    }
    .upload-area:hover i {
      color: var(--color-primary);
    }
    .upload-area h3 {
      font-size: 20px;
      color: var(--text-dark);
      margin-bottom: 10px;
    }
    .upload-area p {
      color: var(--text-muted);
      font-size: 14px;
    }
    .upload-area input[type="file"] {
      display: none;
    }
    .tipo-dados-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }
    .tipo-dado-card {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    .tipo-dado-card:hover {
      border-color: var(--color-primary);
      transform: translateY(-2px);
    }
    .tipo-dado-card.selected {
      border-color: var(--color-primary);
      background: rgba(45, 152, 70, 0.05);
    }
    .tipo-dado-card i {
      font-size: 32px;
      margin-bottom: 12px;
      color: var(--color-primary);
    }
    .tipo-dado-card h4 {
      font-size: 14px;
      color: var(--text-dark);
      margin-bottom: 4px;
    }
    .tipo-dado-card p {
      font-size: 11px;
      color: var(--text-muted);
    }
    .preview-section {
      display: none;
      margin-top: 30px;
    }
    .preview-section.show {
      display: block;
    }
    .preview-info {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .preview-info i {
      font-size: 24px;
      color: var(--color-primary);
    }
    .preview-info .info-text h4 {
      font-size: 14px;
      color: var(--text-dark);
      margin-bottom: 4px;
    }
    .preview-info .info-text p {
      font-size: 12px;
      color: var(--text-muted);
    }
    .action-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 30px;
    }
    .btn-lg {
      padding: 14px 32px;
      font-size: 15px;
    }
    .status-message {
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    .status-message.success {
      display: block;
      background: #f0fdf4;
      border: 1px solid #86efac;
      color: #166534;
    }
    .status-message.error {
      display: block;
      background: #fef2f2;
      border: 1px solid #fca5a5;
      color: #dc2626;
    }
    .status-message.info {
      display: block;
      background: #eff6ff;
      border: 1px solid #93c5fd;
      color: #1d4ed8;
    }
    /* Sub-op√ß√µes de despesas */
    .sub-opcoes { display: none; margin-top: 20px; }
    .sub-opcoes.show { display: block; }
    .sub-opcoes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; max-width: 800px; margin: 0 auto; }
    .sub-opcao-card {
      border: 2px solid #e2e8f0; border-radius: 12px; padding: 24px; cursor: pointer;
      transition: all 0.3s; text-align: center; background: white;
    }
    .sub-opcao-card:hover { border-color: #059669; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.08); }
    .sub-opcao-card.selected { border-color: #059669; background: rgba(5,150,105,.05); box-shadow: 0 0 0 3px rgba(5,150,105,.2); }
    .sub-opcao-card i { font-size: 36px; margin-bottom: 12px; color: #059669; }
    .sub-opcao-card h4 { font-size: 15px; color: var(--text-dark); margin-bottom: 6px; }
    .sub-opcao-card p { font-size: 12px; color: var(--text-muted); margin: 0; }
    /* Upload de pasta (planilhas brutas) */
    .upload-brutos { display: none; margin-top: 24px; }
    .upload-brutos.show { display: block; }
    .upload-brutos .folder-input-wrap { position: relative; display: inline-block; }
    .upload-brutos .folder-input-wrap input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .file-grid-detect { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 16px 0; }
    .file-slot { display: flex; align-items: center; gap: 8px; padding: 10px 14px;
      border: 1px solid #e2e8f0; border-radius: 8px; font-size: 13px; background: #f8fafc; }
    .file-slot .role { font-weight: 600; color: #475569; min-width: 140px; }
    .file-slot .fname { color: #059669; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .file-slot .missing { color: #dc2626; font-style: italic; }
    .file-slot.ok { border-color: #86efac; background: #f0fdf4; }
    .file-slot.err { border-color: #fca5a5; background: #fef2f2; }
    .file-slot.warn { border-color: #fcd34d; background: #fefce8; }
    .progress-bar-pipe { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin: 12px 0; }
    .progress-bar-pipe .fill { height: 100%; background: #059669; border-radius: 4px; transition: width .3s; }
    .phase-log-pipe { font-size: 12px; color: #64748b; margin: 8px 0; max-height: 200px; overflow-y: auto;
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; }
    .phase-line-pipe { margin: 2px 0; }
  </style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="img/brasao-caruaru.png" alt="Bras√£o Caruaru">
      </div>
      <h1 class="sidebar-title">Secretaria da Fazenda</h1>
      <button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-chevron-left"></i></button>
    </div>
    <nav class="sidebar-menu">
      <div class="menu-section">
        <div class="menu-section-title" onclick="toggleSection(this)"><i class="fas fa-tachometer-alt"></i><span>Vis√£o Geral</span><i class="fas fa-chevron-right section-arrow"></i></div>
        <ul>
          <li class="menu-item"><a href="dashboard.html" class="menu-link"><i class="fas fa-home"></i><span>Dashboard Executivo</span></a></li>
          <li class="menu-item"><a href="resultado-orcamentario.html" class="menu-link"><i class="fas fa-chart-pie"></i><span>Resultado Or√ßament√°rio</span></a></li>
        </ul>
      </div>
      <div class="menu-section">
        <div class="menu-section-title" onclick="toggleSection(this)">
          <i class="fas fa-hand-holding-usd"></i>
          <span>Receitas</span>
          <i class="fas fa-chevron-right section-arrow"></i>
        </div>
        <ul>
          <li class="menu-item"><a href="receitas-previsao.html" class="menu-link"><i class="fas fa-chart-line"></i><span>Previs√£o</span></a></li>
          <li class="menu-item"><a href="receitas-arrecadacao.html" class="menu-link"><i class="fas fa-money-bill-wave"></i><span>Arrecada√ß√£o</span></a></li>
          <li class="menu-item"><a href="receitas-retencoes.html" class="menu-link"><i class="fas fa-hand-holding-usd"></i><span>Reten√ß√µes</span></a></li>
          <li class="menu-item"><a href="receitas-deducoes.html" class="menu-link"><i class="fas fa-minus-circle"></i><span>Dedu√ß√µes</span></a></li>
          <li class="menu-item"><a href="receitas-gerencial.html" class="menu-link"><i class="fas fa-tachometer-alt"></i><span>Gerencial</span></a></li>
          <li class="menu-item"><a href="receitas-comparativos.html" class="menu-link"><i class="fas fa-balance-scale"></i><span>Comparativos</span></a></li>
        </ul>
      </div>
      <div class="menu-section">
        <div class="menu-section-title" onclick="toggleSection(this)">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Despesas</span>
          <i class="fas fa-chevron-right section-arrow"></i>
        </div>
        <ul>
          <li class="menu-item"><a href="despesas-empenhados.html" class="menu-link"><i class="fas fa-file-invoice"></i><span>Empenhados</span></a></li>
          <li class="menu-item"><a href="despesas-liquidados.html" class="menu-link"><i class="fas fa-check-circle"></i><span>Liquidados</span></a></li>
          <li class="menu-item"><a href="despesas-retidos.html" class="menu-link"><i class="fas fa-hand-holding-usd"></i><span>Retidos</span></a></li>
          <li class="menu-item"><a href="despesas-pagos.html" class="menu-link"><i class="fas fa-money-check-alt"></i><span>Pagos</span></a></li>
          <li class="menu-item"><a href="despesas-a-pagar.html" class="menu-link"><i class="fas fa-clock"></i><span>A Pagar</span></a></li>
          <li class="menu-item"><a href="despesas-gerencial.html" class="menu-link"><i class="fas fa-chart-line"></i><span>Gerencial</span></a></li>
          <li class="menu-item"><a href="despesas-comparativos.html" class="menu-link"><i class="fas fa-balance-scale"></i><span>Comparativos</span></a></li>
        </ul>
      </div>
      <div class="menu-section">
        <div class="menu-section-title" onclick="toggleSection(this)">
          <i class="fas fa-search-dollar"></i>
          <span>An√°lises</span>
          <i class="fas fa-chevron-right section-arrow"></i>
        </div>
        <ul>
          <li class="menu-item"><a href="despesas-analise.html" class="menu-link"><i class="fas fa-chart-pie"></i><span>An√°lise Financeira</span></a></li>
          <li class="menu-item"><a href="despesas-execucao.html" class="menu-link"><i class="fas fa-chart-bar"></i><span>Execu√ß√£o Or√ßament√°ria</span></a></li>
          <li class="menu-item"><a href="despesas-fontes.html" class="menu-link"><i class="fas fa-layer-group"></i><span>Fontes de Recursos</span></a></li>
          <li class="menu-item"><a href="despesas-credores.html" class="menu-link"><i class="fas fa-users"></i><span>Credores</span></a></li>
          <li class="menu-item"><a href="despesas-natureza.html" class="menu-link"><i class="fas fa-sitemap"></i><span>Natureza da Despesa</span></a></li>
          <li class="menu-item"><a href="limites-legais.html" class="menu-link"><i class="fas fa-gavel"></i><span>Limites Legais</span></a></li>
          <li class="menu-item"><a href="despesas-alertas.html" class="menu-link"><i class="fas fa-exclamation-triangle"></i><span>Alertas</span></a></li>
        </ul>
      </div>
      <div class="menu-section expanded">
        <div class="menu-section-title" onclick="toggleSection(this)">
          <i class="fas fa-database"></i>
          <span>Banco de Dados</span>
          <i class="fas fa-chevron-right section-arrow"></i>
        </div>
        <ul>
          <li class="menu-item"><a href="banco-importar-dados.html" class="menu-link active"><i class="fas fa-file-import"></i><span>Importar Dados</span></a></li>
          <li class="menu-item"><a href="banco-historico.html" class="menu-link"><i class="fas fa-history"></i><span>Hist√≥rico</span></a></li>
          <li class="menu-item"><a href="admin-usuarios.html" class="menu-link"><i class="fas fa-user-shield"></i><span>Usu√°rios</span></a></li>
        </ul>
      </div>
    </nav>
  </aside>
  <div class="sidebar-overlay" onclick="closeSidebar()"></div>
  <div class="main-wrapper">
    <header class="top-header">
      <div style="display: flex; align-items: center; gap: 16px;">
        <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <nav class="breadcrumb">
          <span>Banco de Dados</span>
          <i class="fas fa-chevron-right"></i>
          <span>Importar Dados</span>
        </nav>
      </div>
      <div class="header-actions">
        <div class="user-menu">
          <div class="user-avatar">AD</div>
          <div class="user-info"><span class="user-name">Administrador</span><span class="user-role">SIGEF</span></div>
        </div>
      </div>
    </header>
    <section class="page-header">
      <div class="page-header-content">
        <h1 class="page-title"><i class="fas fa-file-import"></i> Importar Dados</h1>
        <p class="page-subtitle">Importe planilhas Excel para atualizar os dados de receitas e despesas</p>
      </div>
    </section>
    <main class="content-area">

      <!-- Card Principal -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-upload"></i> Enviar Planilha</h2>
          <div class="card-actions">
            <button class="btn btn-secondary" onclick="diagnosticarBanco()" style="background:#dbeafe; color:#1e40af; border:1px solid #bfdbfe; margin-right:8px;">
              <i class="fas fa-info-circle"></i> Verificar Banco
            </button>
            <button class="btn btn-secondary" onclick="limparBancoDadosCarregado()" style="background:#fee2e2; color:#b91c1c; border:1px solid #fecaca;">
              <i class="fas fa-trash"></i> Apagar Dados Carregados
            </button>
          </div>
        </div>
        <div class="card-body">
          
          <!-- Sele√ß√£o do Tipo de Dado -->
          <h3 style="font-size: 15px; margin-bottom: 16px; color: var(--text-dark);">
            <i class="fas fa-list" style="color: var(--color-primary); margin-right: 8px;"></i>
            Selecione o modo de importa√ß√£o:
          </h3>
          
          <!-- Op√ß√µes de Importa√ß√£o -->
          <div class="tipo-dados-grid" style="grid-template-columns: repeat(2, 1fr); max-width: 800px; margin: 0 auto 30px;">
            
            <!-- Importar Despesas -->
            <div style="padding: 24px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 16px; cursor: pointer; transition: all 0.3s;" onclick="selecionarTipoDespesas()" id="importacaoDespesas">
              <div style="text-align: center; color: white;">
                <i class="fas fa-file-invoice-dollar" style="font-size: 48px; margin-bottom: 16px;"></i>
                <h4 style="font-size: 18px; margin: 0 0 8px 0;">Importar Despesas</h4>
                <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 13px;">
                  Arquivos/pasta j√° processados ou planilhas brutas do SIGEF
                </p>
              </div>
            </div>
            
            <!-- Importar Receitas -->
            <div style="padding: 24px; background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); border-radius: 16px; cursor: pointer; transition: all 0.3s;" onclick="selecionarTipo(this)" id="importacaoReceitas">
              <div class="tipo-dado-card" data-tipo="receitas-completo" style="background: transparent; border: none; color: white; margin: 0; padding: 0;">
                <i class="fas fa-coins" style="font-size: 48px; color: white; margin-bottom: 16px;"></i>
                <h4 style="font-size: 18px; margin: 0 0 8px 0; color: white;">Importar Receitas</h4>
                <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 13px;">
                  Planilha Movimentacoes_da_Receita.xlsx<br>
                  Separa automaticamente por: Previs√£o, Arrecada√ß√£o, Reten√ß√µes, Dedu√ß√µes.
                </p>
              </div>
            </div>
            
          </div>

          <!-- Sub-op√ß√µes de Despesas (aparece ao clicar em Despesas) -->
          <div class="sub-opcoes" id="subOpcoesDespesas">
            <h3 style="font-size: 15px; margin-bottom: 16px; color: var(--text-dark); text-align: center;">
              <i class="fas fa-exchange-alt" style="color: #059669; margin-right: 8px;"></i>
              Como deseja importar as despesas?
            </h3>
            <div class="sub-opcoes-grid">
              <div class="sub-opcao-card" id="subDocCompleto" onclick="selecionarSubOpcao('completo')">
                <i class="fas fa-folder-open"></i>
                <h4>Arquivos/Pasta Processados</h4>
                <p>Selecione uma pasta ou arquivos Excel j√° processados (por aba/tipo ou workbook com m√∫ltiplas abas).</p>
              </div>
              <div class="sub-opcao-card" id="subBrutos" onclick="selecionarSubOpcao('brutos')">
                <i class="fas fa-cogs"></i>
                <h4>Planilhas Brutas (SIGEF)</h4>
                <p>9 arquivos Excel brutos do SIGEF. Ser√£o transformados e cruzados automaticamente antes da importa√ß√£o.</p>
              </div>
            </div>
          </div>

          <!-- √Årea de Upload (documento completo / receitas) -->
          <div class="upload-area" id="uploadArea" style="display: none;">
            <i class="fas fa-cloud-upload-alt"></i>
            <h3>Arraste a planilha aqui ou clique para selecionar</h3>
            <p>Formatos aceitos: .xlsx, .xls (Excel)</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
          </div>

          <!-- √Årea de Upload (arquivos/pasta j√° processados) -->
          <div class="upload-brutos" id="uploadProcessados">
            <div style="background: #ecfeff; border: 1px solid #67e8f9; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #0e7490;">
              <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
              Selecione a <strong>pasta</strong> com arquivos <strong>j√° processados</strong>, ou escolha os <strong>arquivos individualmente</strong>.<br>
              Formatos aceitos: <code>.xlsx</code>, <code>.xls</code>, <code>.xlsm</code>.
            </div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
              <div class="folder-input-wrap">
                <button class="btn btn-primary"><i class="fas fa-folder-open"></i> Selecionar Pasta...</button>
                <input type="file" id="processadosFolder" webkitdirectory multiple>
              </div>
              <span style="color:#94a3b8; font-size:13px; padding-top:10px;">ou</span>
              <div class="folder-input-wrap">
                <button class="btn btn-secondary"><i class="fas fa-files"></i> Selecionar Arquivos...</button>
                <input type="file" id="processadosFiles" multiple accept=".xlsx,.xls,.xlsm">
              </div>
            </div>
            <div id="processadosDeteccao"></div>
            <div class="progress-bar-pipe" id="processadosProgressBar" style="display: none;">
              <div class="fill" id="processadosProgressFill" style="width:0%"></div>
            </div>
            <div id="processadosTimer" style="display: none; text-align: center; margin: 12px 0; font-size: 18px; font-weight: 600; color: #3b82f6; font-family: 'Courier New', monospace;">
              ‚è±Ô∏è <span id="processadosTimerValue">00:00</span>
            </div>
            <div id="processadosLog" class="phase-log-pipe" style="display: none;"></div>
            <div id="processadosBotaoImportar" style="display: none; text-align: center; margin-top: 16px;">
              <button class="btn btn-primary btn-lg" id="btnImportarProcessados" onclick="importarProcessados()">
                <i class="fas fa-check"></i> Importar Processados
              </button>
            </div>
          </div>

          <!-- √Årea de Upload (planilhas brutas) -->
          <div class="upload-brutos" id="uploadBrutos">
            <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #1d4ed8;">
              <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
              Selecione a <strong>pasta</strong> contendo os 9 arquivos brutos do SIGEF, ou selecione os <strong>arquivos individualmente</strong>.<br>
              <strong>SIGEF (6):</strong> Emitidos, Liquidados, Pagos, A Pagar, <strong>Consignados Anal√≠tico</strong>, Credores<br>
              <strong>Externos (3):</strong> Balancete, Detalhamento, Simples Nacional <em>(opcional)</em>
            </div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
              <div class="folder-input-wrap">
                <button class="btn btn-primary"><i class="fas fa-folder-open"></i> Selecionar Pasta...</button>
                <input type="file" id="brutosFolder" webkitdirectory multiple>
              </div>
              <span style="color:#94a3b8; font-size:13px; padding-top:10px;">ou</span>
              <div class="folder-input-wrap">
                <button class="btn btn-secondary"><i class="fas fa-files"></i> Selecionar Arquivos...</button>
                <input type="file" id="brutosFiles" multiple accept=".xlsx,.xls,.xlsm">
              </div>
            </div>
            <div id="brutosDeteccao"></div>
            <div class="progress-bar-pipe" id="brutosProgressBar" style="display: none;">
              <div class="fill" id="brutosProgressFill" style="width:0%"></div>
            </div>
            <div id="brutosPhaseLog" class="phase-log-pipe" style="display: none;"></div>
            <div id="brutosBotaoProcessar" style="display: none; text-align: center; margin-top: 16px;">
              <button class="btn btn-primary btn-lg" id="btnProcessarBrutos" onclick="processarBrutos()">
                <i class="fas fa-play"></i> Transformar e Importar
              </button>
            </div>
          </div>

          <!-- Preview dos Dados -->
          <div class="preview-section" id="previewSection">
            <div class="preview-info">
              <i class="fas fa-check-circle"></i>
              <div class="info-text">
                <h4 id="fileName">Arquivo carregado</h4>
                <p id="fileInfo">0 registros encontrados</p>
              </div>
            </div>
            
            <h3 style="font-size: 15px; margin-bottom: 16px; color: var(--text-dark);">
              <i class="fas fa-eye" style="color: var(--color-primary); margin-right: 8px;"></i>
              Pr√©-visualiza√ß√£o dos dados (primeiros 5 registros):
            </h3>
            
            <div class="table-container">
              <table class="data-table" id="previewTable">
                <thead id="previewHeader"></thead>
                <tbody id="previewBody"></tbody>
              </table>
            </div>

            <div class="action-buttons">
              <button class="btn btn-secondary btn-lg" onclick="cancelarImportacao()">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button class="btn btn-primary btn-lg" onclick="confirmarImportacao()">
                <i class="fas fa-check"></i> Confirmar Importa√ß√£o
              </button>
            </div>
          </div>

          <!-- Mensagem de Status -->
          <div class="status-message" id="statusMessage"></div>

        </div>
      </div>

    </main>
    <footer class="main-footer">
      <div class="footer-content">
        <p class="footer-text">¬© 2026 Prefeitura Municipal de Caruaru - SIGEF. Todos os direitos reservados.</p>
      </div>
    </footer>
  </div>

  <script src="js/portal-transparencia.js"></script>
  <script>
    // =====================================================
    // IndexedDB - Banco de dados local para grandes volumes
    // =====================================================
    const DB_NAME = 'PortalTransparenciaDB';
    const DB_VERSION = 2; // Vers√£o aumentada para criar novos stores
    let db = null;
    let dbReady = false;

    // Informa√ß√µes sobre reimporta√ß√£o seletiva (para mostrar nos alertas)
    var infoReimportacao = {
      ativa: false,
      anosImportados: [],
      anosPreservados: [],
      registrosPreservados: 0
    };

    // Inicializar IndexedDB
    function initDB() {
      return new Promise((resolve, reject) => {
        console.log('Iniciando IndexedDB...');
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = (event) => {
          console.error('Erro ao abrir IndexedDB:', event.target.error);
          reject(event.target.error);
        };
        
        request.onsuccess = (event) => {
          db = event.target.result;
          dbReady = true;
          console.log('IndexedDB inicializado com sucesso! Vers√£o:', db.version);
          console.log('Stores dispon√≠veis:', Array.from(db.objectStoreNames));
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          console.log('Atualizando schema do IndexedDB...');
          const database = event.target.result;
          
          // Criar stores para cada tipo de despesa e receita
          const stores = [
            'despesas-empenhados',
            'despesas-liquidados', 
            'despesas-pagos',
            'despesas-retidos',
            'despesas-a-pagar',
            // Stores de Receitas
            'receitas-previsao',
            'receitas-arrecadacao',
            'receitas-retencoes',
            'receitas-deducoes'
          ];
          
          stores.forEach(storeName => {
            if (!database.objectStoreNames.contains(storeName)) {
              database.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
              console.log(`Store ${storeName} criado`);
            }
          });
        };
        
        request.onblocked = () => {
          console.warn('IndexedDB bloqueado! Feche outras abas do sistema.');
          alert('O banco de dados est√° bloqueado. Por favor, feche outras abas do SIGEF e recarregue a p√°gina.');
        };
      });
    }

    // Garantir que o DB est√° pronto antes de salvar
    async function garantirDBPronto() {
      if (dbReady && db) return true;
      try {
        await initDB();
        return true;
      } catch (e) {
        console.error('Falha ao inicializar DB:', e);
        return false;
      }
    }

    // Abrir conex√£o fresca ao IndexedDB (para opera√ß√µes ap√≥s processamento longo)
    function abrirConexaoFresca() {
      return new Promise((resolve, reject) => {
        var request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject(e.target.error);
        request.onupgradeneeded = (event) => {
          var database = event.target.result;
          ['despesas-empenhados','despesas-liquidados','despesas-pagos','despesas-retidos','despesas-a-pagar',
           'receitas-previsao','receitas-arrecadacao','receitas-retencoes','receitas-deducoes'].forEach(s => {
            if (!database.objectStoreNames.contains(s)) database.createObjectStore(s, { keyPath: 'id', autoIncrement: true });
          });
        };
      });
    }

    // Detectar ano de um √∫nico registro
    function detectarAnoDoRegistro(registro) {
      if (!registro) return null;

      // Tentar coluna "Exerc√≠cio" / "Exercicio" / "Ano"
      var exercicio = String(registro['Exerc√≠cio'] || registro['Exercicio'] || registro['Ano'] || '').trim();
      if (exercicio && exercicio.length === 4 && !isNaN(exercicio)) {
        return exercicio;
      }

      // Tentar extrair de "Nr emp." (formato: "123/2024")
      var nrEmp = String(registro['Nr emp.'] || registro['Nr emp'] || registro['N¬∫ emp.'] || '').trim();
      var matchEmp = nrEmp.match(/\/(\d{4})$/);
      if (matchEmp) {
        return matchEmp[1];
      }

      // Tentar extrair de "Data" (formato: "DD/MM/YYYY")
      var data = String(registro['Data'] || registro['Data empenho'] || registro['Data do empenho'] || '').trim();
      var matchData = data.match(/\/(\d{4})$/);
      if (matchData) {
        return matchData[1];
      }

      return null;
    }

    // Detectar automaticamente os anos presentes nos dados
    function detectarAnosNosDados(dados) {
      if (!dados || dados.length === 0) return [];

      var anosSet = new Set();
      for (var i = 0; i < dados.length; i++) {
        var ano = detectarAnoDoRegistro(dados[i]);
        if (ano) anosSet.add(ano);
      }

      var anos = Array.from(anosSet).sort();
      console.log('Anos detectados nos dados:', anos);
      return anos;
    }

    // Extrair total de registros do resultado de salvarDadosDB (compatibilidade)
    function extrairTotal(resultado) {
      if (typeof resultado === 'number') return resultado;
      if (resultado && resultado.totalAdicionados) return resultado.totalAdicionados;
      return 0;
    }

    // Salvar dados no IndexedDB ‚Äî conex√£o fresca + lotes para robustez
    // Suporta reimporta√ß√£o seletiva: preserva dados de anos n√£o selecionados
    async function salvarDadosDB(storeName, dados, anosParaReimportar = null) {
      console.log(`Salvando ${dados.length} registros em ${storeName}...`);

      // Caso especial: substituir tudo sem preserva√ß√£o
      var substituirTudo = (anosParaReimportar === '__REPLACE_ALL__');
      if (substituirTudo) {
        console.log('üóëÔ∏è Substitui√ß√£o total: limpando store e salvando dados novos');
        anosParaReimportar = null; // Reset para n√£o entrar no filtro
      }

      // Se n√£o foram especificados anos E n√£o √© substitui√ß√£o total, detectar automaticamente
      if (!substituirTudo && (!anosParaReimportar || anosParaReimportar.length === 0)) {
        anosParaReimportar = detectarAnosNosDados(dados);
        if (anosParaReimportar.length > 0) {
          console.log('üîÑ Reimporta√ß√£o seletiva ativada automaticamente!');
          console.log('   Anos detectados nos dados a importar:', anosParaReimportar);
          console.log('   Dados de outros anos ser√£o preservados automaticamente.');
        } else {
          console.log('‚ö†Ô∏è Nenhum ano detectado nos dados - n√£o ser√° feita reimporta√ß√£o seletiva');
        }
      } else if (!substituirTudo) {
        console.log('üîÑ Reimporta√ß√£o seletiva manual para anos:', anosParaReimportar);
      }

      // Abrir conex√£o fresca (evita "connection is closing" ap√≥s processamento longo)
      var freshDb = await abrirConexaoFresca();

      try {
        var dadosFinais = dados;
        var mantidosDeOutrosAnos = [];

        // Se houver sele√ß√£o de anos E N√ÉO for substitui√ß√£o total, preservar dados de anos n√£o selecionados
        if (!substituirTudo && anosParaReimportar && anosParaReimportar.length > 0 && anosParaReimportar[0] !== '_unico') {
          console.log(`Reimporta√ß√£o seletiva: preservando dados de anos n√£o selecionados...`);

          // 1. Ler dados existentes
          var dadosExistentes = await new Promise((resolve, reject) => {
            var tx = freshDb.transaction([storeName], 'readonly');
            var store = tx.objectStore(storeName);
            var request = store.getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
          });

          console.log(`Dados existentes em ${storeName}: ${dadosExistentes.length} registros`);

          // 2. Filtrar dados existentes: manter apenas anos N√ÉO selecionados
          // CORRE√á√ÉO: Usar detectarAnoDoRegistro que funciona com "Nr emp." e "Data"
          mantidosDeOutrosAnos = dadosExistentes.filter(function(registro) {
            var anoDoRegistro = detectarAnoDoRegistro(registro);
            // Preservar se: (1) n√£o conseguiu detectar ano OU (2) ano N√ÉO est√° na lista para reimportar
            if (!anoDoRegistro) return true; // Sem ano detectado = preservar por seguran√ßa
            return !anosParaReimportar.includes(anoDoRegistro);
          });

          // Detectar quais anos est√£o sendo preservados
          var anosPreservadosSet = new Set();
          for (var i = 0; i < mantidosDeOutrosAnos.length; i++) {
            var ano = detectarAnoDoRegistro(mantidosDeOutrosAnos[i]);
            if (ano) anosPreservadosSet.add(ano);
          }
          var anosPreservados = Array.from(anosPreservadosSet).sort();

          console.log(`üì¶ Preservando ${mantidosDeOutrosAnos.length} registros de ${anosPreservados.length} ano(s): ${anosPreservados.join(', ')}`);
          console.log(`‚úÖ Importando ${dados.length} registros de ${anosParaReimportar.length} ano(s): ${anosParaReimportar.join(', ')}`);

          // Atualizar informa√ß√µes globais de reimporta√ß√£o
          if (anosPreservados.length > 0) {
            infoReimportacao.ativa = true;
            infoReimportacao.anosImportados = anosParaReimportar;
            // Mesclar anos preservados (pode ter m√∫ltiplos stores)
            anosPreservados.forEach(function(ano) {
              if (!infoReimportacao.anosPreservados.includes(ano)) {
                infoReimportacao.anosPreservados.push(ano);
              }
            });
            infoReimportacao.anosPreservados.sort();
            infoReimportacao.registrosPreservados += mantidosDeOutrosAnos.length;
          }

          // 3. Combinar dados mantidos + dados novos
          dadosFinais = mantidosDeOutrosAnos.concat(dados);
        }

        // 4. Limpar store completamente
        await new Promise((resolve, reject) => {
          var tx = freshDb.transaction([storeName], 'readwrite');
          tx.objectStore(storeName).clear();
          tx.oncomplete = () => resolve();
          tx.onerror = (e) => reject(e.target.error);
          tx.onabort = () => reject(new Error('Limpeza abortada em ' + storeName));
        });

        // 5. Inserir em lotes de 10000 (otimizado para grandes volumes)
        // 5. Inserir em lotes menores (2000) com l√≥gica de RETRY para evitar travamentos
        // Reduzido de 10.000 para 2.000 para evitar TransactionAbortError
        var BATCH = 2000;
        var totalAdicionados = 0;

        // CORRE√á√ÉO: Renumerar IDs sequencialmente para evitar duplicatas
        // Isso √© crucial quando h√° dados preservados + novos dados
        for (var idx = 0; idx < dadosFinais.length; idx++) {
          dadosFinais[idx].id = idx + 1;
        }

        for (var offset = 0; offset < dadosFinais.length; offset += BATCH) {
          var fim = Math.min(offset + BATCH, dadosFinais.length);

          try {
            // Tenta inserir o lote principal
            await new Promise((resolve, reject) => {
              var tx = freshDb.transaction([storeName], 'readwrite');
              var store = tx.objectStore(storeName);

              tx.oncomplete = () => resolve();
              tx.onerror = (e) => reject(e.target.error);
              tx.onabort = (e) => reject(new Error('Lote ' + offset + '-' + fim + ' abortado'));

              for (var i = offset; i < fim; i++) {
                // IDs j√° foram atribu√≠dos acima - apenas fazer put
                store.put(dadosFinais[i]);
              }
            });
            totalAdicionados += (fim - offset);
          } catch (erroLote) {
            console.warn(`Erro no lote ${offset}-${fim}. Tentando em sub-lotes menores...`, erroLote);

            // Se falhar, tenta inserir em sub-lotes muito menores para garantir
            // Isso √© mais lento, mas muito mais robusto
            var SUB_BATCH = 50; // Reduzido de 100 para 50 para maior robustez
            for (var subOffset = offset; subOffset < fim; subOffset += SUB_BATCH) {
              var subFim = Math.min(subOffset + SUB_BATCH, fim);

              try {
                // Pequeno delay para evitar sobrecarga do IndexedDB
                await new Promise(r => setTimeout(r, 10));

                await new Promise((resolve, reject) => {
                  var tx = freshDb.transaction([storeName], 'readwrite'); // Nova transa√ß√£o para cada sub-lote
                  var store = tx.objectStore(storeName);

                  tx.oncomplete = () => resolve();
                  tx.onerror = (e) => reject(e.target.error);
                  tx.onabort = (e) => {
                    console.error('Transa√ß√£o abortada no sub-lote', subOffset, '-', subFim);
                    reject(new Error('Sub-lote abortado'));
                  };

                  for (var j = subOffset; j < subFim; j++) {
                    // IDs j√° foram atribu√≠dos acima - apenas fazer put
                    store.put(dadosFinais[j]);
                  }
                });
                totalAdicionados += (subFim - subOffset);
              } catch (erroSub) {
                console.error(`Falha fatal no sub-lote ${subOffset}-${subFim}:`, erroSub);
                console.error('Dados problem√°ticos (primeiro registro):', dadosFinais[subOffset]);
                throw erroSub; // Se falhar at√© no sub-lote, aborta tudo
              }
            }
          }
        }

        var resultado = { totalAdicionados: totalAdicionados };

        if (mantidosDeOutrosAnos.length > 0) {
          var anosPreservadosSet = new Set();
          for (var i = 0; i < mantidosDeOutrosAnos.length; i++) {
            var ex = String(mantidosDeOutrosAnos[i]['Exerc√≠cio'] || mantidosDeOutrosAnos[i]['Exercicio'] || mantidosDeOutrosAnos[i]['Ano'] || '').trim();
            if (ex) anosPreservadosSet.add(ex);
          }
          var anosPreservados = Array.from(anosPreservadosSet).sort();

          console.log(`‚úÖ ${totalAdicionados} registros salvos em ${storeName} (${mantidosDeOutrosAnos.length} preservados + ${dados.length} novos)`);

          resultado.preservados = mantidosDeOutrosAnos.length;
          resultado.novos = dados.length;
          resultado.anosPreservados = anosPreservados;
          resultado.anosImportados = anosParaReimportar;
        } else {
          console.log(`‚úÖ ${totalAdicionados} registros salvos em ${storeName}`);
        }
        return resultado;
      } finally {
        // Fechar a conex√£o fresca ap√≥s uso
        freshDb.close();
      }
    }

    function getStoresSistema() {
      return [
        'despesas-empenhados',
        'despesas-liquidados',
        'despesas-pagos',
        'despesas-retidos',
        'despesas-a-pagar',
        'receitas-previsao',
        'receitas-arrecadacao',
        'receitas-retencoes',
        'receitas-deducoes'
      ];
    }

    async function limparBancoDadosCarregado() {
      var confirmar = confirm(
        'Isso vai apagar TODOS os dados importados (despesas, receitas e hist√≥rico).\n\nDeseja continuar?'
      );
      if (!confirmar) {
        console.log('Limpeza cancelada pelo usu√°rio');
        return;
      }

      try {
        console.log('Iniciando limpeza do banco de dados...');
        mostrarStatus('Apagando dados carregados...', 'info');

        var freshDb = await abrirConexaoFresca();
        console.log('Conex√£o com banco estabelecida');

        try {
          var stores = getStoresSistema();
          console.log('Stores a limpar:', stores);

          // Limpar cada store individualmente em transa√ß√µes separadas (mais robusto)
          for (var i = 0; i < stores.length; i++) {
            try {
              await new Promise((resolve, reject) => {
                var tx = freshDb.transaction([stores[i]], 'readwrite');
                var store = tx.objectStore(stores[i]);
                var clearRequest = store.clear();

                clearRequest.onsuccess = () => {
                  console.log('Store limpo:', stores[i]);
                };

                tx.oncomplete = () => resolve();
                tx.onerror = (e) => {
                  console.warn('Erro ao limpar store ' + stores[i] + ':', e.target.error);
                  // N√£o rejeita, continua com pr√≥ximo store
                  resolve();
                };
                tx.onabort = () => {
                  console.warn('Transa√ß√£o abortada para store:', stores[i]);
                  resolve();
                };
              });
            } catch (storeError) {
              console.warn('Erro ao limpar store ' + stores[i] + ', continuando...', storeError);
            }
          }

          console.log('Todos os stores foram processados');
        } finally {
          freshDb.close();
          console.log('Conex√£o com banco fechada');
        }

        // Limpar hist√≥rico
        localStorage.removeItem('historico-importacoes');
        console.log('Hist√≥rico de importa√ß√µes removido');

        // Verificar se realmente foi limpo
        var verificacao = await verificarBancoVazio();
        console.log('Verifica√ß√£o de limpeza:', verificacao);

        mostrarStatus('Banco limpo com sucesso! Todos os dados importados foram apagados.', 'success');
        alert('Banco de dados limpo com sucesso!\n\nTotal de registros removidos: ' + verificacao.totalRemovido);
      } catch (e) {
        console.error('Erro ao limpar banco:', e);
        mostrarStatus('Erro ao limpar banco: ' + e.message, 'error');

        // Oferecer op√ß√£o de for√ßar limpeza
        var forcar = confirm('Erro ao limpar banco normalmente.\n\nDeseja FOR√áAR a limpeza deletando o banco completamente?\n\nAVISO: Isso vai recriar o banco do zero.');
        if (forcar) {
          await forcarLimpezaCompleta();
        }
      }
    }

    // Verificar se o banco est√° vazio
    async function verificarBancoVazio() {
      var freshDb = await abrirConexaoFresca();
      try {
        var stores = getStoresSistema();
        var totalRemovido = 0;
        var detalhes = {};

        for (var i = 0; i < stores.length; i++) {
          var count = await new Promise((resolve, reject) => {
            var tx = freshDb.transaction([stores[i]], 'readonly');
            var store = tx.objectStore(stores[i]);
            var countRequest = store.count();
            countRequest.onsuccess = () => resolve(countRequest.result);
            countRequest.onerror = () => resolve(0);
          });
          detalhes[stores[i]] = count;
          totalRemovido += count;
        }

        return { totalRemovido: totalRemovido, detalhes: detalhes };
      } finally {
        freshDb.close();
      }
    }

    // For√ßar limpeza completa deletando e recriando o banco
    async function forcarLimpezaCompleta() {
      try {
        console.log('For√ßando limpeza completa - deletando banco...');
        mostrarStatus('For√ßando limpeza completa...', 'info');

        // Fechar conex√µes abertas
        if (db) {
          db.close();
          db = null;
        }

        // Deletar banco completamente
        await new Promise((resolve, reject) => {
          var deleteRequest = indexedDB.deleteDatabase(DB_NAME);
          deleteRequest.onsuccess = () => {
            console.log('Banco deletado com sucesso');
            resolve();
          };
          deleteRequest.onerror = (e) => {
            console.error('Erro ao deletar banco:', e);
            reject(e);
          };
          deleteRequest.onblocked = () => {
            console.warn('Dele√ß√£o bloqueada - fechando todas as conex√µes...');
            // Tenta resolver o bloqueio
            setTimeout(() => resolve(), 1000);
          };
        });

        // Limpar hist√≥rico
        localStorage.removeItem('historico-importacoes');

        // Recriar banco
        dbReady = false;
        await initDB();

        mostrarStatus('Banco limpo com sucesso! (limpeza for√ßada)', 'success');
        alert('Banco de dados limpo com sucesso!\n\nO banco foi deletado e recriado do zero.');
      } catch (e) {
        console.error('Erro ao for√ßar limpeza:', e);
        mostrarStatus('Erro ao for√ßar limpeza: ' + e.message, 'error');
        alert('Erro ao for√ßar limpeza: ' + e.message + '\n\nTente recarregar a p√°gina (F5) e tente novamente.');
      }
    }

    // Diagnosticar banco de dados
    async function diagnosticarBanco() {
      try {
        mostrarStatus('Verificando banco de dados...', 'info');
        console.log('Iniciando diagn√≥stico do banco...');

        var freshDb = await abrirConexaoFresca();
        try {
          var stores = getStoresSistema();
          var diagnostico = [];
          var totalRegistros = 0;
          var anosEncontrados = new Set();

          for (var i = 0; i < stores.length; i++) {
            var count = await new Promise((resolve, reject) => {
              var tx = freshDb.transaction([stores[i]], 'readonly');
              var store = tx.objectStore(stores[i]);
              var countRequest = store.count();
              countRequest.onsuccess = () => resolve(countRequest.result);
              countRequest.onerror = () => resolve(0);
            });

            // Buscar anos presentes neste store
            if (count > 0) {
              var amostra = await new Promise((resolve, reject) => {
                var tx = freshDb.transaction([stores[i]], 'readonly');
                var store = tx.objectStore(stores[i]);
                var getAllRequest = store.getAll();
                getAllRequest.onsuccess = () => resolve(getAllRequest.result || []);
                getAllRequest.onerror = () => resolve([]);
              });

              amostra.forEach(function(registro) {
                var ano = detectarAnoDoRegistro(registro);
                if (ano) anosEncontrados.add(ano);
              });
            }

            var nomeAmigavel = stores[i].replace('despesas-', '').replace('receitas-', '').replace('-', ' ');
            diagnostico.push(nomeAmigavel + ': ' + count.toLocaleString() + ' registros');
            totalRegistros += count;
          }

          var anosArray = Array.from(anosEncontrados).sort();
          console.log('Diagn√≥stico completo:', diagnostico);
          console.log('Anos encontrados:', anosArray);

          var mensagem = 'DIAGN√ìSTICO DO BANCO DE DADOS\n\n' +
                        'Total de registros: ' + totalRegistros.toLocaleString() + '\n\n' +
                        'Anos no banco: ' + (anosArray.length > 0 ? anosArray.join(', ') : 'nenhum') + '\n\n' +
                        'Detalhamento por categoria:\n\n' +
                        diagnostico.join('\n') + '\n\n' +
                        'Banco: ' + DB_NAME + ' (vers√£o ' + DB_VERSION + ')';

          mostrarStatus('Diagn√≥stico conclu√≠do: ' + totalRegistros.toLocaleString() + ' registros no banco', 'success');
          alert(mensagem);
        } finally {
          freshDb.close();
        }
      } catch (e) {
        console.error('Erro ao diagnosticar banco:', e);
        mostrarStatus('Erro ao diagnosticar banco: ' + e.message, 'error');
        alert('Erro ao diagnosticar banco:\n\n' + e.message);
      }
    }

    // Carregar dados do IndexedDB
    async function carregarDadosDB(storeName) {
      const pronto = await garantirDBPronto();
      if (!pronto) {
        throw new Error('Banco de dados n√£o dispon√≠vel');
      }
      
      return new Promise((resolve, reject) => {
        try {
          const transaction = db.transaction([storeName], 'readonly');
          const store = transaction.objectStore(storeName);
          const request = store.getAll();
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        } catch (e) {
          console.error('Erro ao carregar dados:', e);
          reject(e);
        }
      });
    }

    // Inicializar DB ao carregar p√°gina
    initDB()
      .then(() => {
        console.log('DB pronto para uso!');
        console.log('');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üîÑ REIMPORTA√á√ÉO SELETIVA POR ANO');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('');
        console.log('Este sistema agora preserva automaticamente dados de anos');
        console.log('n√£o selecionados durante a importa√ß√£o.');
        console.log('');
        console.log('EXEMPLO:');
        console.log('  ‚Ä¢ Banco atual: 2023, 2024, 2025');
        console.log('  ‚Ä¢ Voc√™ importa: apenas 2025');
        console.log('  ‚Ä¢ Resultado: 2023 e 2024 s√£o PRESERVADOS');
        console.log('               2025 √© SUBSTITU√çDO');
        console.log('');
        console.log('Para verificar os anos no banco, clique no bot√£o');
        console.log('"Verificar Banco" ou execute: diagnosticarBanco()');
        console.log('');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('');

        // Mostrar status de sucesso brevemente
        const statusEl = document.getElementById('statusMessage');
        if (statusEl) {
          statusEl.textContent = '‚úì Sistema pronto para importa√ß√£o';
          statusEl.className = 'status-message success';
          setTimeout(() => {
            statusEl.className = 'status-message';
          }, 3000);
        }
      })
      .catch(err => {
        console.error('Erro ao inicializar IndexedDB:', err);

        // Se for erro de bloqueio, tenta novamente ap√≥s 3 segundos
        if (err && err.name === 'QuotaExceededError' || err.message === 'IndexedDB bloqueado') {
          mostrarStatus('‚ö† Banco bloqueado. Tentando reconectar...', 'warning');
          setTimeout(() => {
            window.location.reload();
          }, 3000);
          return;
        }

        // Outros erros
        mostrarStatus('ERRO: Banco de dados n√£o p√¥de ser inicializado. Recarregue a p√°gina (F5).', 'error');

        const mensagem = 'Erro ao inicializar o sistema!\n\n' +
                        'POSS√çVEIS CAUSAS:\n' +
                        '1. Voc√™ tem v√°rias abas do SIGEF abertas\n' +
                        '2. O navegador est√° bloqueando o IndexedDB\n\n' +
                        'SOLU√á√ÉO:\n' +
                        '‚úì Feche TODAS as outras abas do SIGEF\n' +
                        '‚úì Recarregue esta p√°gina (F5)\n' +
                        '‚úì Se persistir, feche o navegador completamente e reabra';

        alert(mensagem);
      });

    // =====================================================
    // Vari√°veis globais
    // =====================================================
    let tipoSelecionado = null;
    let dadosImportados = null;
    let dadosMultiplasAbas = null; // Para importa√ß√£o autom√°tica

    // Mapeamento das abas do Excel para chaves do localStorage
    // Mapeamento flex√≠vel de abas - aceita v√°rias varia√ß√µes dos nomes
    const mapeamentoAbas = {
      // Empenhados - v√°rias formas
      'empenhados': 'despesas-empenhados',
      'empenhado': 'despesas-empenhados',
      'empenhos': 'despesas-empenhados',
      'empenho': 'despesas-empenhados',
      'emp': 'despesas-empenhados',
      // Liquidados - v√°rias formas
      'liquidados': 'despesas-liquidados',
      'liquidado': 'despesas-liquidados',
      'liquidacoes': 'despesas-liquidados',
      'liquida√ß√µes': 'despesas-liquidados',
      'liquidacao': 'despesas-liquidados',
      'liquida√ß√£o': 'despesas-liquidados',
      'liq': 'despesas-liquidados',
      // Pagos - v√°rias formas
      'pagos': 'despesas-pagos',
      'pago': 'despesas-pagos',
      'pagamentos': 'despesas-pagos',
      'pagamento': 'despesas-pagos',
      'pag': 'despesas-pagos',
      // A Pagar - v√°rias formas
      'a pagar': 'despesas-a-pagar',
      'apagar': 'despesas-a-pagar',
      'a_pagar': 'despesas-a-pagar',
      'a-pagar': 'despesas-a-pagar',
      'restos': 'despesas-a-pagar',
      'restos a pagar': 'despesas-a-pagar',
      'rap': 'despesas-a-pagar',
      // Retidos - v√°rias formas
      'retidos': 'despesas-retidos',
      'retido': 'despesas-retidos',
      'retencoes': 'despesas-retidos',
      'reten√ß√µes': 'despesas-retidos',
      'retencao': 'despesas-retidos',
      'reten√ß√£o': 'despesas-retidos',
      'ret': 'despesas-retidos'
    };
    
    // Mapeamento do campo "Hist√≥rico" da planilha de receitas para stores
    const mapeamentoHistoricoReceitas = {
      'previs√£o da receita or√ßament√°ria': 'receitas-previsao',
      'previsao da receita orcamentaria': 'receitas-previsao',
      'arrecada√ß√£o de receita': 'receitas-arrecadacao',
      'arrecadacao de receita': 'receitas-arrecadacao',
      'apropria√ß√£o de reten√ß√£o/consigna√ß√£o': 'receitas-retencoes',
      'apropriacao de retencao/consignacao': 'receitas-retencoes',
      'dedu√ß√£o de receita': 'receitas-deducoes',
      'deducao de receita': 'receitas-deducoes'
    };

    // =====================================================
    // Fun√ß√£o para converter data serial do Excel para DD/MM/AAAA
    // =====================================================
    function converterDataExcel(valor) {
      // Se j√° for string no formato de data, retorna
      if (typeof valor === 'string') {
        // J√° est√° no formato DD/MM/AAAA
        if (valor.match(/^\d{2}\/\d{2}\/\d{4}$/)) return valor;
        // Formato AAAA-MM-DD (ISO)
        if (valor.match(/^\d{4}-\d{2}-\d{2}/)) {
          const partes = valor.split('T')[0].split('-');
          return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
        return valor;
      }
      
      // Se for n√∫mero (serial do Excel)
      if (typeof valor === 'number' && valor > 0) {
        // Excel usa 1/1/1900 como dia 1 (com bug do ano bissexto 1900)
        // JavaScript usa 1/1/1970 como epoch
        // Diferen√ßa: 25569 dias entre 1/1/1900 e 1/1/1970
        const diasDesde1900 = valor;
        const milissegundosPorDia = 24 * 60 * 60 * 1000;
        
        // Ajuste: Excel considera 1/1/1900 = 1, ent√£o subtra√≠mos 1
        // Tamb√©m h√° o bug do Excel que considera 1900 como bissexto
        const ajuste = diasDesde1900 > 60 ? 25567 : 25568;
        
        const data = new Date((diasDesde1900 - ajuste) * milissegundosPorDia);
        
        if (isNaN(data.getTime())) return valor;
        
        const dia = String(data.getUTCDate()).padStart(2, '0');
        const mes = String(data.getUTCMonth() + 1).padStart(2, '0');
        const ano = data.getUTCFullYear();
        
        return `${dia}/${mes}/${ano}`;
      }
      
      return valor;
    }
    
    // Converter todas as colunas de data em um registro
    function converterDatasRegistro(registro) {
      const colunasData = ['Data', 'data', 'DATA', 'Dt.', 'dt.'];
      const novoRegistro = { ...registro };
      
      for (const coluna of Object.keys(novoRegistro)) {
        // Verificar se √© coluna de data pelo nome
        const isDataCol = colunasData.some(d => coluna.toLowerCase().includes(d.toLowerCase()));
        
        if (isDataCol || (typeof novoRegistro[coluna] === 'number' && novoRegistro[coluna] > 40000 && novoRegistro[coluna] < 60000)) {
          novoRegistro[coluna] = converterDataExcel(novoRegistro[coluna]);
        }
      }
      
      return novoRegistro;
    }
    
    // Converter datas em um array de registros
    function converterDatasArray(dados) {
      return dados.map(registro => converterDatasRegistro(registro));
    }

    function normalizarChaveColuna(chave) {
      return String(chave || '')
        .toLowerCase()
        .trim()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s]/g, ' ')
        .replace(/_/g, ' ')
        .replace(/\s+/g, ' ');
    }

    function normalizarRegistroProcessado(registro) {
      var aliasParaCanonical = {
        'seq liq': 'Seq. Liq.',
        'seq liquidacao': 'Seq. Liq.',
        'seq liquid': 'Seq. Liq.',
        'av liquid': 'Seq. Liq.',
        'av liquidacao': 'Seq. Liq.',
        'cnpj cpf': 'CNPJ&CPF',
        'cpf cnpj': 'CNPJ&CPF',
        'cnpj cpf do credor': 'CNPJ&CPF',
        'detalhamento despesa': 'Detalhamento despesa'
      };

      var out = {};
      var keys = Object.keys(registro || {});
      for (var i = 0; i < keys.length; i++) {
        var k = keys[i];
        var v = registro[k];
        var nk = normalizarChaveColuna(k);
        var canonical = aliasParaCanonical[nk] || k;

        if (canonical === 'CNPJ&CPF' && v != null) {
          v = String(v).trim();
        }

        if (out[canonical] == null || out[canonical] === '') {
          out[canonical] = v;
        }
      }
      return out;
    }

    // Modelos de colunas para cada tipo de dado
    const modelosColunas = {
      'despesas-empenhados': ['Nr emp.', 'Data', 'Credor/Fornecedor', 'Esp√©cie', 'Unidade or√ßament√°ria', 'Valor (R$)'],
      'despesas-liquidados': ['Seq. liq.', 'Nr emp.', 'Data', 'Credor/Fornecedor', 'Esp√©cie', 'Valor (R$)'],
      'despesas-pagos': ['Nr Emp.', 'Seq. Liq.', 'Data', 'Credor/Fornecedor', 'Valor (R$)'],
      'despesas-retidos': ['Sequ√™ncia', 'Nr emp.', 'Data', 'Credor/Fornecedor', 'Reten√ß√£o', 'Valor retido'],
      'despesas-a-pagar': ['Nr emp.', 'Av. liquid.', 'Data', 'Credor/Fornecedor', 'Valor(R$)']
    };

    // =====================================================
    // Selecionar modo de importa√ß√£o
    // =====================================================
    let modoImportacao = null; // 'processados', 'brutos', 'receitas'
    let arquivosProcessadosSelecionados = [];
    // brutosDetectados removido ‚Äî agora usa brutosPorAno/brutosAnos

    function resetSelecao() {
      document.getElementById('importacaoDespesas').style.boxShadow = 'none';
      document.getElementById('importacaoDespesas').style.transform = 'scale(1)';
      document.getElementById('importacaoReceitas').style.boxShadow = 'none';
      document.getElementById('importacaoReceitas').style.transform = 'scale(1)';
      document.getElementById('subOpcoesDespesas').classList.remove('show');
      document.getElementById('uploadArea').style.display = 'none';
      document.getElementById('uploadProcessados').classList.remove('show');
      document.getElementById('uploadBrutos').classList.remove('show');
      document.getElementById('previewSection').classList.remove('show');
      document.getElementById('processadosDeteccao').innerHTML = '';
      document.getElementById('processadosBotaoImportar').style.display = 'none';
      document.getElementById('processadosFolder').value = '';
      document.getElementById('processadosFiles').value = '';
      document.querySelectorAll('.sub-opcao-card').forEach(c => c.classList.remove('selected'));
      modoImportacao = null;
      arquivosProcessadosSelecionados = [];
      brutosPorAno = {};
      brutosAnos = [];
      esconderStatus();
    }

    // Clicar em "Importar Despesas" √¢‚Ä†‚Äô mostra sub-op√ß√µes
    function selecionarTipoDespesas() {
      resetSelecao();
      tipoSelecionado = 'despesas-completo';
      document.getElementById('importacaoDespesas').style.boxShadow = '0 0 0 4px rgba(5, 150, 105, 0.5)';
      document.getElementById('importacaoDespesas').style.transform = 'scale(1.02)';
      document.getElementById('subOpcoesDespesas').classList.add('show');
      document.getElementById('subOpcoesDespesas').scrollIntoView({ behavior: 'smooth' });
    }

    // Sub-op√ß√£o de despesas: completo ou brutos
    function selecionarSubOpcao(modo) {
      document.querySelectorAll('.sub-opcao-card').forEach(c => c.classList.remove('selected'));
      modoImportacao = modo;

      if (modo === 'completo') {
        document.getElementById('subDocCompleto').classList.add('selected');
        modoImportacao = 'processados';
        document.getElementById('uploadArea').style.display = 'none';
        document.getElementById('uploadProcessados').classList.add('show');
        document.getElementById('uploadBrutos').classList.remove('show');
        mostrarStatus('Selecione pasta/arquivos j√° processados para importar automaticamente.', 'success');
        document.getElementById('uploadProcessados').scrollIntoView({ behavior: 'smooth' });
      } else if (modo === 'brutos') {
        document.getElementById('subBrutos').classList.add('selected');
        document.getElementById('uploadArea').style.display = 'none';
        document.getElementById('uploadProcessados').classList.remove('show');
        document.getElementById('uploadBrutos').classList.add('show');
        mostrarStatus('Selecione a pasta ou os arquivos brutos do SIGEF para transforma√ß√£o autom√°tica.', 'success');
        document.getElementById('uploadBrutos').scrollIntoView({ behavior: 'smooth' });
      }
    }

    // Clicar em "Importar Receitas" (mant√©m comportamento original)
    function selecionarTipo(elemento) {
      resetSelecao();
      const card = elemento.querySelector('.tipo-dado-card') || elemento;
      tipoSelecionado = card.getAttribute('data-tipo');

      if (tipoSelecionado === 'receitas-completo') {
        modoImportacao = 'receitas';
        document.getElementById('importacaoReceitas').style.boxShadow = '0 0 0 4px rgba(37, 99, 235, 0.5)';
        document.getElementById('importacaoReceitas').style.transform = 'scale(1.02)';
        document.getElementById('uploadArea').style.display = '';
        mostrarStatus('Receitas selecionadas! Fa√ßa upload da planilha "Movimentacoes_da_Receita.xlsx".', 'success');
        document.getElementById('uploadArea').scrollIntoView({ behavior: 'smooth' });
      }
    }

    // Configurar √°rea de upload quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', function() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      
      console.log('Configurando √°rea de upload...');
      console.log('uploadArea encontrado:', !!uploadArea);
      console.log('fileInput encontrado:', !!fileInput);
      
      if (!uploadArea || !fileInput) {
        console.error('Elementos de upload n√£o encontrados!');
        return;
      }
      
      // Drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('dragover');
        console.log('Arquivo solto via drag and drop');
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
      });
      
      // Click para selecionar
      uploadArea.addEventListener('click', function(e) {
        console.log('√Årea de upload clicada');
        fileInput.click();
      });
      
      // Quando arquivo √© selecionado
      fileInput.addEventListener('change', function(e) {
        console.log('Arquivo selecionado via input');
        const file = this.files[0];
        if (file) {
          console.log('Arquivo:', file.name, 'Tamanho:', file.size);
          handleFile(file);
        }
      });
      
      console.log('√Årea de upload configurada com sucesso!');
    });

    // Processar arquivo Excel
    function handleFile(file) {
      console.log('=== handleFile chamado ===');
      console.log('Arquivo:', file);
      console.log('tipoSelecionado:', tipoSelecionado);
      console.log('XLSX dispon√≠vel:', typeof XLSX !== 'undefined');
      
      // Verificar se SheetJS est√° carregado
      if (typeof XLSX === 'undefined') {
        mostrarStatus('ERRO: Biblioteca de leitura de Excel n√£o carregou. Recarregue a p√°gina.', 'error');
        alert('Erro: Biblioteca SheetJS n√£o carregou.\n\nPor favor, recarregue a p√°gina (F5).');
        return;
      }
      
      if (!tipoSelecionado) {
        mostrarStatus('ATEN√á√ÉO: Primeiro selecione o modo de importa√ß√£o (Despesas ou Receitas)!', 'error');
        alert('Por favor, selecione o modo de importa√ß√£o primeiro!\n\nClique em "Importar Despesas" ou "Importar Receitas".');
        return;
      }

      if (!file || !file.name) {
        mostrarStatus('Nenhum arquivo selecionado.', 'error');
        return;
      }

      if (!file.name.match(/\.(xlsx|xls)$/i)) {
        mostrarStatus('Por favor, envie um arquivo Excel (.xlsx ou .xls)', 'error');
        alert('Formato inv√°lido!\n\nEnvie um arquivo Excel com extens√£o .xlsx ou .xls');
        return;
      }

      mostrarStatus('Processando arquivo "' + file.name + '"...', 'info');
      console.log('Iniciando leitura do arquivo...');

      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          console.log('Arquivo lido com sucesso! Tamanho:', e.target.result.byteLength, 'bytes');
          mostrarStatus('Arquivo lido! Processando planilha...', 'info');
          
          const data = new Uint8Array(e.target.result);
          console.log('Convertido para Uint8Array. Chamando XLSX.read...');
          
          const workbook = XLSX.read(data, {
            type: 'array',
            cellFormula: false,
            cellStyles: false,
            cellHTML: false,
            cellNF: false,
            cellDates: false
          });
          console.log('Planilha processada! Abas encontradas:', workbook.SheetNames);
          
          // Modo de importa√ß√£o autom√°tica (todas as despesas)
          if (tipoSelecionado === 'despesas-completo') {
            processarMultiplasAbas(workbook, file.name);
            return;
          }
          
          // Modo de importa√ß√£o de receitas (filtra por campo Hist√≥rico)
          if (tipoSelecionado === 'receitas-completo') {
            processarReceitasPorHistorico(workbook, file.name);
            return;
          }
          
          // Modo individual (uma aba)
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          let jsonData = XLSX.utils.sheet_to_json(firstSheet);
          
          // Converter datas do formato serial do Excel para DD/MM/AAAA
          jsonData = converterDatasArray(jsonData);
          
          console.log('Dados extra√≠dos:', jsonData.length, 'registros');
          
          if (jsonData.length === 0) {
            mostrarStatus('A planilha est√° vazia ou n√£o tem dados v√°lidos.', 'error');
            alert('Planilha vazia!\n\nA planilha n√£o cont√©m dados. Verifique se preencheu corretamente.');
            return;
          }

          dadosImportados = jsonData;
          dadosMultiplasAbas = null;
          console.log('dadosImportados definido:', dadosImportados);
          
          // Mostrar preview
          document.getElementById('fileName').textContent = file.name;
          document.getElementById('fileInfo').textContent = `${jsonData.length} registros encontrados - Pronto para importar!`;
          
          // Criar cabe√ßalho da tabela
          const headers = Object.keys(jsonData[0]);
          const headerRow = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
          document.getElementById('previewHeader').innerHTML = headerRow;
          
          // Criar linhas da tabela (m√°ximo 5)
          const previewData = jsonData.slice(0, 5);
          const bodyRows = previewData.map(row => {
            return '<tr>' + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + '</tr>';
          }).join('');
          document.getElementById('previewBody').innerHTML = bodyRows;
          
          // Mostrar se√ß√£o de preview
          document.getElementById('previewSection').classList.add('show');
          
          mostrarStatus(`Arquivo carregado! ${jsonData.length} registros prontos. Clique em "Confirmar Importa√ß√£o" abaixo.`, 'success');
          
          // Scroll para a se√ß√£o de preview
          document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
          
        } catch (error) {
          console.error('ERRO ao processar planilha:', error);
          mostrarStatus('Erro ao processar a planilha: ' + error.message, 'error');
          alert('Erro ao processar o arquivo!\n\n' + error.message + '\n\nVerifique se o arquivo √© um Excel v√°lido.');
        }
      };
      
      reader.onerror = function(error) {
        console.error('ERRO de leitura do arquivo:', error);
        mostrarStatus('Erro ao ler o arquivo. Tente novamente.', 'error');
        alert('Erro ao ler o arquivo!\n\nTente selecionar o arquivo novamente.');
      };
      
      reader.onprogress = function(e) {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          console.log('Progresso de leitura:', percent + '%');
        }
      };
      
      console.log('Iniciando readAsArrayBuffer...');
      reader.readAsArrayBuffer(file);
    }
    
    // Processar m√∫ltiplas abas (modo autom√°tico)
    function processarMultiplasAbas(workbook, fileName) {
      console.log('Processando m√∫ltiplas abas...');
      console.log('Abas encontradas:', workbook.SheetNames);
      
      dadosMultiplasAbas = {};
      let totalRegistros = 0;
      let abasProcessadas = [];
      
      workbook.SheetNames.forEach(nomeAba => {
        // Normalizar nome: lowercase, sem acentos, sem espa√ßos extras
        const nomeNormalizado = nomeAba
          .toLowerCase()
          .trim()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '') // Remove acentos
          .replace(/\s+/g, ' '); // M√∫ltiplos espa√ßos √¢‚Ä†‚Äô um espa√ßo
        
        console.log(`Processando aba: "${nomeAba}" √¢‚Ä†‚Äô normalizado: "${nomeNormalizado}"`);
        
        let tipoDestino = null;
        
        // Mapear nome da aba para tipo de despesa
        for (const [chave, valor] of Object.entries(mapeamentoAbas)) {
          const chaveNormalizada = chave
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '');
          
          // Verificar se cont√©m a chave ou se √© igual
          if (nomeNormalizado.includes(chaveNormalizada) || nomeNormalizado === chaveNormalizada) {
            tipoDestino = valor;
            console.log(`  √¢‚Ä†‚Äô Match encontrado: "${chave}" √¢‚Ä†‚Äô "${valor}"`);
            break;
          }
        }
        
        if (tipoDestino) {
          const sheet = workbook.Sheets[nomeAba];
          let dados = XLSX.utils.sheet_to_json(sheet);
          
          // Converter datas do formato serial do Excel
          dados = converterDatasArray(dados);
          
          if (dados.length > 0) {
            // Se j√° existe dados para esse tipo, mesclar
            if (dadosMultiplasAbas[tipoDestino]) {
              console.log(`  √¢‚Ä†‚Äô Mesclando com dados existentes de ${tipoDestino}`);
              dadosMultiplasAbas[tipoDestino] = [...dadosMultiplasAbas[tipoDestino], ...dados];
            } else {
              dadosMultiplasAbas[tipoDestino] = dados;
            }
            totalRegistros += dados.length;
            abasProcessadas.push(`${nomeAba} (${dados.length} registros) √¢‚Ä†‚Äô ${tipoDestino}`);
            console.log(`  ‚úì Aba "${nomeAba}" mapeada para "${tipoDestino}" com ${dados.length} registros`);
          } else {
            console.log(`  √¢≈ì‚Äî Aba "${nomeAba}" est√° vazia`);
          }
        } else {
          console.log(`  √¢≈ì‚Äî Aba "${nomeAba}" n√£o reconhecida, ignorada.`);
          console.log(`    Nomes aceitos: empenhados, liquidados, pagos, a pagar, retidos (e varia√ß√µes)`);
        }
      });
      
      if (Object.keys(dadosMultiplasAbas).length === 0) {
        const abasEncontradas = workbook.SheetNames.join(', ');
        mostrarStatus(`Nenhuma aba v√°lida encontrada! Abas na planilha: ${abasEncontradas}`, 'error');
        alert(`Nenhuma aba reconhecida!\n\nAbas encontradas na planilha:\n${workbook.SheetNames.map(a => '‚Ä¢ ' + a).join('\n')}\n\nAs abas devem ter nomes como:\n- Empenhados\n- Liquidados\n- Pagos\n- A Pagar\n- Retidos`);
        return;
      }
      
      // Mostrar resumo no console
      console.log('=== RESUMO DA IMPORTA√á√ÉO ===');
      console.log('Total de categorias detectadas:', Object.keys(dadosMultiplasAbas).length);
      Object.entries(dadosMultiplasAbas).forEach(([tipo, dados]) => {
        console.log(`  - ${tipo}: ${dados.length} registros`);
      });
      
      dadosImportados = null; // Usar dadosMultiplasAbas ao inv√©s
      
      // Mostrar preview resumido
      document.getElementById('fileName').textContent = fileName;
      document.getElementById('fileInfo').innerHTML = `
        <strong style="color: #059669; font-size: 18px;">${totalRegistros.toLocaleString()} registros encontrados em ${Object.keys(dadosMultiplasAbas).length} categorias!</strong><br><br>
        <div style="text-align: left; padding: 10px; background: #f8fafc; border-radius: 8px; margin-top: 10px;">
          ${abasProcessadas.map(a => `<div style="padding: 4px 0;">‚úì ${a}</div>`).join('')}
        </div>
      `;
      
      // Preview da primeira aba encontrada
      const primeiroTipo = Object.keys(dadosMultiplasAbas)[0];
      const primeiroDados = dadosMultiplasAbas[primeiroTipo];
      const headers = Object.keys(primeiroDados[0]);
      const headerRow = '<tr>' + headers.slice(0, 8).map(h => `<th>${h}</th>`).join('') + '</tr>';
      document.getElementById('previewHeader').innerHTML = headerRow;
      
      const previewData = primeiroDados.slice(0, 3);
      const bodyRows = previewData.map(row => {
        return '<tr>' + headers.slice(0, 8).map(h => `<td>${String(row[h] || '').substring(0, 20)}</td>`).join('') + '</tr>';
      }).join('');
      document.getElementById('previewBody').innerHTML = bodyRows + `<tr><td colspan="${Math.min(8, headers.length)}" style="text-align:center; color:#64748b; padding:10px;">... e mais ${totalRegistros - 3} registros</td></tr>`;
      
      // Mostrar se√ß√£o de preview
      document.getElementById('previewSection').classList.add('show');
      
      mostrarStatus(`Arquivo processado! ${totalRegistros.toLocaleString()} registros em ${Object.keys(dadosMultiplasAbas).length} categorias. Clique em "Confirmar Importa√ß√£o".`, 'success');
      
      document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Processar planilha de receitas filtrando pelo campo "Hist√≥rico"
    function processarReceitasPorHistorico(workbook, fileName) {
      console.log('Processando receitas por campo Hist√≥rico...');
      console.log('Abas encontradas:', workbook.SheetNames);
      
      // Ler primeira aba (ou aba com dados)
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      let todosOsDados = XLSX.utils.sheet_to_json(firstSheet);
      
      // Converter datas do formato serial do Excel para DD/MM/AAAA
      todosOsDados = converterDatasArray(todosOsDados);
      
      console.log('Total de registros na planilha:', todosOsDados.length);
      
      if (todosOsDados.length === 0) {
        mostrarStatus('A planilha est√° vazia ou n√£o tem dados v√°lidos.', 'error');
        alert('Planilha vazia!\n\nA planilha n√£o cont√©m dados.');
        return;
      }
      
      // Identificar a coluna de Hist√≥rico (pode ter encoding diferente)
      const primeiroRegistro = todosOsDados[0];
      const colunas = Object.keys(primeiroRegistro);
      let colunaHistorico = colunas.find(c => 
        c.toLowerCase().includes('histor') || 
        c.toLowerCase().includes('hist√≥rico') ||
        c.toLowerCase() === 'historico'
      );
      
      if (!colunaHistorico) {
        mostrarStatus('Coluna "Hist√≥rico" n√£o encontrada na planilha! Colunas dispon√≠veis: ' + colunas.join(', '), 'error');
        alert('Coluna "Hist√≥rico" n√£o encontrada!\n\nAs colunas dispon√≠veis s√£o:\n' + colunas.join('\n'));
        return;
      }
      
      console.log('Coluna de Hist√≥rico identificada:', colunaHistorico);
      
      // Separar dados por tipo de hist√≥rico
      dadosMultiplasAbas = {
        'receitas-previsao': [],
        'receitas-arrecadacao': [],
        'receitas-retencoes': [],
        'receitas-deducoes': []
      };
      
      let naoMapeados = 0;
      
      todosOsDados.forEach(registro => {
        const valorHistorico = registro[colunaHistorico];
        if (!valorHistorico) {
          naoMapeados++;
          return;
        }
        
        // Normalizar o valor do hist√≥rico
        const historicoNormalizado = String(valorHistorico)
          .toLowerCase()
          .trim()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, ''); // Remove acentos
        
        // Encontrar o store correspondente
        let storeDestino = null;
        for (const [chave, valor] of Object.entries(mapeamentoHistoricoReceitas)) {
          const chaveNormalizada = chave
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '');
          if (historicoNormalizado.includes(chaveNormalizada) || chaveNormalizada.includes(historicoNormalizado)) {
            storeDestino = valor;
            break;
          }
        }
        
        if (storeDestino && dadosMultiplasAbas[storeDestino]) {
          dadosMultiplasAbas[storeDestino].push(registro);
        } else {
          naoMapeados++;
          console.log('Hist√≥rico n√£o mapeado:', valorHistorico);
        }
      });
      
      // Remover categorias vazias
      Object.keys(dadosMultiplasAbas).forEach(key => {
        if (dadosMultiplasAbas[key].length === 0) {
          delete dadosMultiplasAbas[key];
        }
      });
      
      if (Object.keys(dadosMultiplasAbas).length === 0) {
        mostrarStatus('Nenhum registro reconhecido! Verifique se a coluna "Hist√≥rico" cont√©m valores como: Previs√£o da Receita, Arrecada√ß√£o, Reten√ß√£o, Dedu√ß√£o.', 'error');
        return;
      }
      
      // Calcular totais
      let totalRegistros = 0;
      let resumoCategoria = [];
      
      const nomesAmigaveis = {
        'receitas-previsao': 'Previs√£o Or√ßament√°ria',
        'receitas-arrecadacao': 'Arrecada√ß√£o',
        'receitas-retencoes': 'Reten√ß√µes/Consigna√ß√µes',
        'receitas-deducoes': 'Dedu√ß√µes'
      };
      
      Object.entries(dadosMultiplasAbas).forEach(([tipo, dados]) => {
        totalRegistros += dados.length;
        
        // Calcular valor total da categoria
        const colunaValor = colunas.find(c => c.toLowerCase().includes('valor'));
        let valorTotal = 0;
        if (colunaValor) {
          dados.forEach(d => {
            const val = parseFloat(d[colunaValor]) || 0;
            valorTotal += val;
          });
        }
        
        resumoCategoria.push({
          tipo: tipo,
          nome: nomesAmigaveis[tipo] || tipo,
          quantidade: dados.length,
          valor: valorTotal
        });
      });
      
      dadosImportados = null; // Usar dadosMultiplasAbas
      
      // Mostrar preview
      document.getElementById('fileName').textContent = fileName;
      document.getElementById('fileInfo').innerHTML = `
        <strong style="color: #2563eb; font-size: 18px;">${totalRegistros.toLocaleString()} registros de receitas encontrados em ${Object.keys(dadosMultiplasAbas).length} categorias!</strong><br><br>
        <div style="text-align: left; padding: 10px; background: #f8fafc; border-radius: 8px; margin-top: 10px;">
          ${resumoCategoria.map(r => `
            <div style="padding: 6px 0; border-bottom: 1px solid #e2e8f0;">
              <span style="color: #22c55e; margin-right: 8px;">‚úì</span>
              <strong>${r.nome}:</strong> ${r.quantidade.toLocaleString()} registros
              ${r.valor !== 0 ? `<span style="color: #64748b; float: right;">R$ ${r.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>` : ''}
            </div>
          `).join('')}
          ${naoMapeados > 0 ? `<div style="padding: 6px 0; color: #f59e0b;"><i class="fas fa-exclamation-triangle"></i> ${naoMapeados} registros sem categoria identificada</div>` : ''}
        </div>
      `;
      
      // Preview da primeira categoria
      const primeiroTipo = Object.keys(dadosMultiplasAbas)[0];
      const primeiroDados = dadosMultiplasAbas[primeiroTipo];
      const headers = Object.keys(primeiroDados[0]).slice(0, 6);
      const headerRow = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
      document.getElementById('previewHeader').innerHTML = headerRow;
      
      const previewData = primeiroDados.slice(0, 3);
      const bodyRows = previewData.map(row => {
        return '<tr>' + headers.map(h => `<td>${String(row[h] || '').substring(0, 30)}</td>`).join('') + '</tr>';
      }).join('');
      document.getElementById('previewBody').innerHTML = bodyRows + `<tr><td colspan="${headers.length}" style="text-align:center; color:#64748b; padding:10px;">... e mais ${totalRegistros - 3} registros</td></tr>`;
      
      // Mostrar se√ß√£o de preview
      document.getElementById('previewSection').classList.add('show');
      
      mostrarStatus(`Planilha de receitas processada! ${totalRegistros.toLocaleString()} registros em ${Object.keys(dadosMultiplasAbas).length} categorias. Clique em "Confirmar Importa√ß√£o".`, 'success');
      
      document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Baixar modelo de planilha
    function baixarModelo(tipo) {
      const colunas = modelosColunas[tipo];
      if (!colunas) return;

      // Criar planilha com cabe√ßalhos e uma linha de exemplo
      const ws_data = [colunas];
      
      // Adicionar linha de exemplo baseada no tipo
      const exemplos = {
        'receitas-empenhados': ['2026NE00001', '02/01/2026', 'EMPRESA EXEMPLO LTDA', '12.345.678/0001-90', '3.3.90.39 - Outros Servi√ßos', '125000.00', 'Empenhado'],
        'receitas-liquidados': ['2026LQ00001', '15/01/2026', '2026NE00001', 'EMPRESA EXEMPLO LTDA', '125000.00', 'Liquidado'],
        'despesas-empenhados': ['2026NE00001', '05/01/2026', 'EMPRESA EXEMPLO LTDA', '12.345.678/0001-90', 'Sec. Educa√ß√£o', '4.4.90.51 - Obras', '250000.00', 'Empenhado'],
        'despesas-liquidados': ['2026LQ00001', '20/01/2026', '2026NE00001', 'EMPRESA EXEMPLO LTDA', 'Sec. Educa√ß√£o', '250000.00', 'Liquidado'],
        'despesas-pagos': ['2026OP00001', '25/01/2026', 'EMPRESA EXEMPLO LTDA', 'Banco do Brasil', '1234-5', '250000.00', 'Confirmado'],
        'retencoes': ['2026NE00001', '15/01/2026', 'EMPRESA EXEMPLO LTDA', 'INSS', '11%', '13750.00', 'Recolhido']
      };
      
      ws_data.push(exemplos[tipo] || []);

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Dados');
      
      // Ajustar largura das colunas
      ws['!cols'] = colunas.map(() => ({ wch: 20 }));
      
      XLSX.writeFile(wb, `modelo_${tipo}.xlsx`);
      
      mostrarStatus(`Modelo "${tipo}" baixado com sucesso! Preencha e fa√ßa o upload.`, 'success');
    }

    // Confirmar importa√ß√£o
    async function confirmarImportacao() {
      // Modo autom√°tico (m√∫ltiplas abas) - Despesas
      if (tipoSelecionado === 'despesas-completo' && dadosMultiplasAbas) {
        confirmarImportacaoMultipla();
        return;
      }
      
      // Modo autom√°tico - Receitas (filtradas por Hist√≥rico)
      if (tipoSelecionado === 'receitas-completo' && dadosMultiplasAbas) {
        confirmarImportacaoReceitas();
        return;
      }
      
      // Modo individual
      if (!dadosImportados || !tipoSelecionado) {
        mostrarStatus('Erro: Selecione um tipo de dados e fa√ßa upload de um arquivo primeiro.', 'error');
        return;
      }

      try {
        mostrarStatus('Salvando dados no banco de dados...', 'info');
        
        const totalRegistros = dadosImportados.length;
        const nomeArquivo = document.getElementById('fileName').textContent;
        
        // Salvar no IndexedDB
        await salvarDadosDB(tipoSelecionado, dadosImportados);
        
        // Registrar no hist√≥rico
        registrarImportacao(
          tipoSelecionado,
          tipoSelecionado.replace('despesas-', 'Despesas ').replace('receitas-', 'Receitas ').replace('-', ' '),
          totalRegistros,
          nomeArquivo
        );
        
        mostrarStatus(`${totalRegistros.toLocaleString()} registros importados com sucesso!`, 'success');
        
        // Limpar
        document.getElementById('previewSection').classList.remove('show');
        document.getElementById('fileInput').value = '';
        dadosImportados = null;
        
        // Mostrar alerta de sucesso
        alert(`Importa√ß√£o conclu√≠da!\n\n${totalRegistros} registros salvos.\n\nAgora voc√™ pode acessar a p√°gina de ${tipoSelecionado.replace('despesas-', 'Despesas ').replace('-', ' ')} para ver os dados.`);
        
      } catch (erro) {
        console.error('Erro ao salvar:', erro);
        mostrarStatus('Erro ao salvar os dados: ' + erro.message, 'error');
      }
    }
    
    // Confirmar importa√ß√£o de m√∫ltiplas abas (modo autom√°tico)
    async function confirmarImportacaoMultipla() {
      var t0 = performance.now(); // Iniciar medi√ß√£o de tempo
      // Resetar informa√ß√µes de reimporta√ß√£o
      infoReimportacao = { ativa: false, anosImportados: [], anosPreservados: [], registrosPreservados: 0 };

      try {
        mostrarStatus('Salvando dados no banco de dados... Por favor aguarde.', 'info');

        let resumoImportacao = [];
        let totalGeral = 0;
        const tipos = Object.keys(dadosMultiplasAbas);
        const nomeArquivo = document.getElementById('fileName').textContent;
        
        for (let i = 0; i < tipos.length; i++) {
          const tipo = tipos[i];
          const dados = dadosMultiplasAbas[tipo];
          
          mostrarStatus(`Salvando ${tipo}... (${i + 1}/${tipos.length})`, 'info');
          
          // Salvar no IndexedDB
          await salvarDadosDB(tipo, dados);
          
          const nomeTipo = tipo.replace('despesas-', 'Despesas ').replace('-', ' ');
          resumoImportacao.push(`‚úì ${nomeTipo}: ${dados.length.toLocaleString()} registros`);
          totalGeral += dados.length;
          
          console.log(`Salvos ${dados.length} registros em ${tipo}`);
        }
        
        var tempoSeg = ((performance.now() - t0) / 1000).toFixed(1);

        console.log('=== IMPORTA√á√ÉO CONCLU√çDA ===');
        console.log('Tempo total:', tempoSeg + 's');
        console.log('Total de registros:', totalGeral.toLocaleString());
        console.log('Categorias importadas:', tipos.length);

        // Registrar no hist√≥rico
        registrarImportacao(
          'despesas-completo',
          `Importa√ß√£o Completa de Despesas (${tipos.length} categorias)`,
          totalGeral,
          nomeArquivo
        );

        mostrarStatus(`Importa√ß√£o completa! ${totalGeral.toLocaleString()} registros em ${tempoSeg}s.`, 'success');

        // Limpar
        document.getElementById('previewSection').classList.remove('show');
        document.getElementById('fileInput').value = '';
        dadosImportados = null;
        dadosMultiplasAbas = null;

        // Construir mensagem com informa√ß√µes de reimporta√ß√£o seletiva
        var mensagem = `IMPORTA√á√ÉO CONCLU√çDA COM SUCESSO!\n\n${totalGeral.toLocaleString()} registros importados em ${tempoSeg}s:\n\n${resumoImportacao.join('\n')}`;

        if (infoReimportacao.ativa) {
          mensagem += '\n\nüîÑ REIMPORTA√á√ÉO SELETIVA:';
          mensagem += '\n‚úÖ Anos importados: ' + infoReimportacao.anosImportados.join(', ');
          mensagem += '\nüì¶ Anos preservados: ' + infoReimportacao.anosPreservados.join(', ');
          mensagem += '\n   (' + infoReimportacao.registrosPreservados.toLocaleString() + ' registros mantidos)';
        }

        mensagem += '\n\nAgora voc√™ pode acessar as p√°ginas de despesas para visualizar os dados.';

        alert(mensagem);
        
      } catch (erro) {
        console.error('Erro ao salvar:', erro);
        mostrarStatus('Erro ao salvar os dados: ' + erro.message, 'error');
        alert('Erro ao salvar os dados!\n\n' + erro.message);
      }
    }

    // Confirmar importa√ß√£o de receitas (filtradas por Hist√≥rico)
    async function confirmarImportacaoReceitas() {
      var t0 = performance.now(); // Iniciar medi√ß√£o de tempo
      // Resetar informa√ß√µes de reimporta√ß√£o
      infoReimportacao = { ativa: false, anosImportados: [], anosPreservados: [], registrosPreservados: 0 };

      try {
        mostrarStatus('Salvando dados de receitas no banco de dados... Por favor aguarde.', 'info');

        let resumoImportacao = [];
        let totalGeral = 0;
        const tipos = Object.keys(dadosMultiplasAbas);
        const nomeArquivo = document.getElementById('fileName').textContent;
        
        const nomesAmigaveis = {
          'receitas-previsao': 'Previs√£o Or√ßament√°ria',
          'receitas-arrecadacao': 'Arrecada√ß√£o',
          'receitas-retencoes': 'Reten√ß√µes/Consigna√ß√µes',
          'receitas-deducoes': 'Dedu√ß√µes'
        };
        
        for (let i = 0; i < tipos.length; i++) {
          const tipo = tipos[i];
          const dados = dadosMultiplasAbas[tipo];
          
          mostrarStatus(`Salvando ${nomesAmigaveis[tipo] || tipo}... (${i + 1}/${tipos.length})`, 'info');
          
          // Salvar no IndexedDB
          await salvarDadosDB(tipo, dados);
          
          resumoImportacao.push(`‚úì ${nomesAmigaveis[tipo]}: ${dados.length.toLocaleString()} registros`);
          totalGeral += dados.length;
          
          console.log(`Salvos ${dados.length} registros em ${tipo}`);
        }
        
        var tempoSeg = ((performance.now() - t0) / 1000).toFixed(1);

        console.log('=== IMPORTA√á√ÉO DE RECEITAS CONCLU√çDA ===');
        console.log('Tempo total:', tempoSeg + 's');
        console.log('Total de registros:', totalGeral.toLocaleString());
        console.log('Categorias importadas:', tipos.length);

        // Registrar no hist√≥rico
        registrarImportacao(
          'receitas-completo',
          `Importa√ß√£o Completa de Receitas (${tipos.length} categorias)`,
          totalGeral,
          nomeArquivo
        );

        mostrarStatus(`Importa√ß√£o de receitas completa! ${totalGeral.toLocaleString()} registros em ${tempoSeg}s.`, 'success');

        // Limpar
        document.getElementById('previewSection').classList.remove('show');
        document.getElementById('fileInput').value = '';
        dadosImportados = null;
        dadosMultiplasAbas = null;

        // Construir mensagem com informa√ß√µes de reimporta√ß√£o seletiva
        var mensagem = `IMPORTA√á√ÉO DE RECEITAS CONCLU√çDA!\n\n${totalGeral.toLocaleString()} registros importados em ${tempoSeg}s:\n\n${resumoImportacao.join('\n')}`;

        if (infoReimportacao.ativa) {
          mensagem += '\n\nüîÑ REIMPORTA√á√ÉO SELETIVA:';
          mensagem += '\n‚úÖ Anos importados: ' + infoReimportacao.anosImportados.join(', ');
          mensagem += '\nüì¶ Anos preservados: ' + infoReimportacao.anosPreservados.join(', ');
          mensagem += '\n   (' + infoReimportacao.registrosPreservados.toLocaleString() + ' registros mantidos)';
        }

        mensagem += '\n\nAgora voc√™ pode acessar as p√°ginas de receitas para visualizar os dados.';

        alert(mensagem);
        
      } catch (erro) {
        console.error('Erro ao salvar:', erro);
        mostrarStatus('Erro ao salvar os dados: ' + erro.message, 'error');
        alert('Erro ao salvar os dados!\n\n' + erro.message);
      }
    }

    // Cancelar importa√ß√£o
    function cancelarImportacao() {
      document.getElementById('previewSection').classList.remove('show');
      document.getElementById('fileInput').value = '';
      dadosImportados = null;
      dadosMultiplasAbas = null;
      esconderStatus();
    }

    // Mostrar mensagem de status
    function mostrarStatus(mensagem, tipo) {
      const el = document.getElementById('statusMessage');
      el.textContent = mensagem;
      el.className = 'status-message ' + tipo;
    }

    // Esconder mensagem de status
    function esconderStatus() {
      document.getElementById('statusMessage').className = 'status-message';
    }

    // =====================================================
    // Registro de Hist√≥rico de Importa√ß√µes
    // =====================================================
    
    // Fun√ß√£o para salvar no hist√≥rico - usa chave fixa
    function salvarHistorico(historico) {
      localStorage.setItem('historico-importacoes', JSON.stringify(historico));
    }
    
    // Fun√ß√£o para carregar hist√≥rico - usa chave fixa
    function carregarHistorico() {
      try {
        const dados = localStorage.getItem('historico-importacoes');
        return dados ? JSON.parse(dados) : [];
      } catch (e) {
        console.error('Erro ao carregar hist√≥rico:', e);
        return [];
      }
    }

    // Fun√ß√£o para registrar importa√ß√£o no hist√≥rico
    function registrarImportacao(tipo, descricao, registros, arquivo) {
      console.log('=== REGISTRANDO IMPORTA√á√ÉO ===');
      console.log('Tipo:', tipo);
      console.log('Descri√ß√£o:', descricao);
      console.log('Registros:', registros);
      console.log('Arquivo:', arquivo);
      
      try {
        // Carregar hist√≥rico existente
        const historico = carregarHistorico();
        console.log('Hist√≥rico atual tem', historico.length, 'registros');
        
        // Criar novo registro
        const novoRegistro = {
          id: Date.now(),
          tipo: tipo,
          descricao: descricao,
          registros: registros,
          arquivo: arquivo || 'Arquivo n√£o especificado',
          dataHora: new Date().toISOString()
        };
        
        // Adicionar no in√≠cio (mais recente primeiro)
        historico.unshift(novoRegistro);
        
        // Manter apenas os √∫ltimos 100 registros
        while (historico.length > 100) {
          historico.pop();
        }
        
        // Salvar no localStorage
        salvarHistorico(historico);
        
        // Verificar se foi salvo
        const verificacao = carregarHistorico();
        console.log('Hist√≥rico ap√≥s salvar:', verificacao.length, 'registros');
        console.log('√öltimo registro:', verificacao[0]);
        
        if (verificacao.length > 0 && verificacao[0].id === novoRegistro.id) {
          console.log('‚úì Registro salvo com sucesso!');
        } else {
          console.error('√¢≈ì‚Äî ERRO: Registro n√£o foi salvo corretamente!');
          alert('ERRO: N√£o foi poss√≠vel salvar no hist√≥rico. Verifique se o localStorage est√° habilitado no navegador.');
        }
        
        return novoRegistro;
      } catch (e) {
        console.error('ERRO ao registrar hist√≥rico:', e);
        alert('Erro ao registrar no hist√≥rico: ' + e.message + '\n\nVerifique o console do navegador (F12) para mais detalhes.');
        return null;
      }
    }
    
    // Fun√ß√£o para verificar hist√≥rico (debug)
    function verificarHistorico() {
      const historico = carregarHistorico();
      console.log('=== VERIFICA√á√ÉO DO HIST√ìRICO ===');
      console.log('Total de registros:', historico.length);
      if (historico.length > 0) {
        console.log('√öltimos 5 registros:');
        historico.slice(0, 5).forEach((h, i) => {
          console.log(`${i + 1}. ${h.descricao} - ${h.registros} registros - ${new Date(h.dataHora).toLocaleString()}`);
        });
      }
      return historico;
    }
    
    // Verificar hist√≥rico ao carregar a p√°gina (debug)
    console.log('P√°gina de importa√ß√£o carregada. Verificando hist√≥rico...');
    verificarHistorico();

    // =====================================================
    // Importa√ß√£o de arquivos j√° processados (pasta/arquivos)
    // =====================================================
    document.getElementById('processadosFolder').addEventListener('change', function(e) {
      var files = Array.from(e.target.files).filter(function(f) {
        var n = f.name.toLowerCase();
        return (n.endsWith('.xlsx') || n.endsWith('.xls') || n.endsWith('.xlsm')) && !n.startsWith('~$');
      });
      files = filtrarArquivosSomenteProcessados(files);
      detectarArquivosProcessados(files, true);
    });

    document.getElementById('processadosFiles').addEventListener('change', function(e) {
      var files = Array.from(e.target.files).filter(function(f) {
        var n = f.name.toLowerCase();
        return (n.endsWith('.xlsx') || n.endsWith('.xls') || n.endsWith('.xlsm')) && !n.startsWith('~$');
      });
      files = filtrarArquivosSomenteProcessados(files);
      detectarArquivosProcessados(files, false);
    });

    function normalizarTextoSimples(v) {
      return String(v || '')
        .toLowerCase()
        .trim()
        .replace(/[_-]+/g, ' ')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }

    function filtrarArquivosSomenteProcessados(files) {
      if (!files || !files.length) return [];

      var comPastaProcessados = files.filter(function(f) {
        var p = String(f.webkitRelativePath || '').toLowerCase().replace(/\\/g, '/');
        return p.includes('/processados/');
      });
      if (comPastaProcessados.length > 0) return comPastaProcessados;

      var comPrefixoV2 = files.filter(function(f) {
        return /^v2\b/.test(normalizarTextoSimples(f.name));
      });
      if (comPrefixoV2.length > 0) return comPrefixoV2;

      return files;
    }

    function inferirStorePorNomeArquivo(nomeArquivo) {
      var n = normalizarTextoSimples(nomeArquivo);
      if (n.includes('liquidad')) return 'despesas-liquidados';
      if (n.includes('pagos') || n.includes('pagamento')) return 'despesas-pagos';
      if (n.includes('emitid') || n.includes('empenhad')) return 'despesas-empenhados';
      if (n.includes('a pagar') || n.includes('apagar') || n.includes('restos')) return 'despesas-a-pagar';
      if (n.includes('retid') || n.includes('consign')) return 'despesas-retidos';
      return null;
    }

    function detectarArquivosProcessados(files, isPasta) {
      arquivosProcessadosSelecionados = files || [];
      var container = document.getElementById('processadosDeteccao');
      var btnArea = document.getElementById('processadosBotaoImportar');

      if (!arquivosProcessadosSelecionados.length) {
        container.innerHTML = '';
        btnArea.style.display = 'none';
        mostrarStatus('Nenhum arquivo processado selecionado.', 'error');
        return;
      }

      var html = '';
      html += '<div style="margin: 10px 0; padding: 10px; border: 1px solid #bae6fd; border-radius: 8px; background: #f0f9ff;">';
      html += '<div style="font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">';
      html += (isPasta ? 'Pasta selecionada' : 'Arquivos selecionados') + ': ' + arquivosProcessadosSelecionados.length + ' arquivo(s)</div>';
      html += '<ul style="margin: 0; padding-left: 18px; color: #334155; font-size: 13px;">';

      for (var i = 0; i < Math.min(arquivosProcessadosSelecionados.length, 15); i++) {
        var f = arquivosProcessadosSelecionados[i];
        var store = inferirStorePorNomeArquivo(f.name);
        var tipo = store ? store.replace('despesas-', '') : 'm√∫ltiplas abas/auto';
        html += '<li>' + f.name + ' <span style="color:#64748b;">(' + tipo + ')</span></li>';
      }
      if (arquivosProcessadosSelecionados.length > 15) {
        html += '<li>... e mais ' + (arquivosProcessadosSelecionados.length - 15) + ' arquivo(s)</li>';
      }

      html += '</ul></div>';
      container.innerHTML = html;
      btnArea.style.display = '';
      mostrarStatus('Arquivos processados selecionados. Clique em "Importar Processados".', 'success');
    }

    async function importarProcessados() {
      if (!arquivosProcessadosSelecionados.length) {
        mostrarStatus('Selecione arquivos processados antes de importar.', 'error');
        return;
      }

      var btn = document.getElementById('btnImportarProcessados');
      btn.disabled = true;
      var t0 = performance.now(); // Iniciar medi√ß√£o de tempo
      // Resetar informa√ß√µes de reimporta√ß√£o
      infoReimportacao = { ativa: false, anosImportados: [], anosPreservados: [], registrosPreservados: 0 };

      // Limpar e iniciar UI de progresso
      document.getElementById('processadosLog').innerHTML = '';
      setProcessadosProgress(0);
      startProcessadosTimer();

      try {
        logProcessados('=== Iniciando Importa√ß√£o de Processados ===');
        mostrarStatus('Lendo arquivos processados...', 'info');
        var acumulado = {
          'despesas-empenhados': [],
          'despesas-liquidados': [],
          'despesas-pagos': [],
          'despesas-a-pagar': [],
          'despesas-retidos': []
        };

        var mapaAbas = {
          'emp. emitidos': 'despesas-empenhados',
          'emp. liquidados': 'despesas-liquidados',
          'emp. pagos': 'despesas-pagos',
          'empenhos a pagar': 'despesas-a-pagar',
          'empenhos retidos': 'despesas-retidos',
          'empenhados': 'despesas-empenhados',
          'liquidados': 'despesas-liquidados',
          'pagos': 'despesas-pagos',
          'a pagar': 'despesas-a-pagar',
          'retidos': 'despesas-retidos'
        };

        logProcessados('Total de arquivos: ' + arquivosProcessadosSelecionados.length);
        logProcessados('');

        for (var i = 0; i < arquivosProcessadosSelecionados.length; i++) {
          var file = arquivosProcessadosSelecionados[i];
          var progressPct = Math.round((i / arquivosProcessadosSelecionados.length) * 70);
          setProcessadosProgress(progressPct);
          logProcessados('üìÑ Arquivo ' + (i + 1) + '/' + arquivosProcessadosSelecionados.length + ': ' + file.name);
          mostrarStatus('Processando ' + (i + 1) + '/' + arquivosProcessadosSelecionados.length + ': ' + file.name, 'info');

          var buffer = await file.arrayBuffer();
          var wb = XLSX.read(new Uint8Array(buffer), { type: 'array' });

          // Se o arquivo tiver m√∫ltiplas abas conhecidas, importa todas as abas √∫teis.
          var encontrouAbaConhecida = false;
          for (var s = 0; s < wb.SheetNames.length; s++) {
            var nomeAba = wb.SheetNames[s];
            var nomeAbaNorm = normalizarTextoSimples(nomeAba);
            var storeFromSheet = mapaAbas[nomeAbaNorm] || null;
            if (!storeFromSheet) continue;
            encontrouAbaConhecida = true;

            var sh = wb.Sheets[nomeAba];
            var dadosAba = XLSX.utils.sheet_to_json(sh, { raw: false, defval: '' });
            if (dadosAba && dadosAba.length) {
              dadosAba = dadosAba.map(normalizarRegistroProcessado);
              acumulado[storeFromSheet] = acumulado[storeFromSheet].concat(dadosAba);
            }
          }

          // Se n√£o encontrou abas conhecidas, trata como arquivo de um tipo s√≥ pelo nome do arquivo.
          if (!encontrouAbaConhecida) {
            var store = inferirStorePorNomeArquivo(file.name);
            if (!store) continue;
            var sheet = wb.Sheets[wb.SheetNames[0]];
            var dados = XLSX.utils.sheet_to_json(sheet, { raw: false, defval: '' });
            if (dados && dados.length) {
              dados = dados.map(normalizarRegistroProcessado);
              acumulado[store] = acumulado[store].concat(dados);
            }
          }
        }

        setProcessadosProgress(70);
        logProcessados('');
        logProcessados('=== Salvando no Banco de Dados ===');

        var resumo = [];
        var total = 0;
        var stores = Object.keys(acumulado);
        var storesComDados = stores.filter(function(st) { return acumulado[st].length > 0; });

        for (var j = 0; j < stores.length; j++) {
          var st = stores[j];
          var dadosStore = acumulado[st];
          if (!dadosStore.length) continue;

          var progressPct = 70 + Math.round((j / storesComDados.length) * 25);
          setProcessadosProgress(progressPct);

          var nomeAmigavel = st.replace('despesas-', 'Despesas ').replace('-', ' ');
          logProcessados('  Salvando ' + nomeAmigavel + '...');

          await salvarDadosDB(st, dadosStore);

          logProcessados('    ‚Üí ' + dadosStore.length.toLocaleString() + ' registros salvos');
          resumo.push('‚úì ' + nomeAmigavel + ': ' + dadosStore.length.toLocaleString() + ' registros');
          total += dadosStore.length;
        }

        if (total === 0) {
          stopProcessadosTimer();
          mostrarStatus('Nenhum dado v√°lido encontrado nos arquivos processados selecionados.', 'error');
          logProcessados('');
          logProcessados('‚ö†Ô∏è Nenhum dado v√°lido encontrado');
          return;
        }

        stopProcessadosTimer();
        var tempoSeg = getProcessadosElapsedTime();
        setProcessadosProgress(100);

        logProcessados('');
        logProcessados('=== Importa√ß√£o Conclu√≠da em ' + tempoSeg + 's ===');
        logProcessados('Total: ' + total.toLocaleString() + ' registros importados');

        if (infoReimportacao.ativa) {
          logProcessados('');
          logProcessados('üîÑ Reimporta√ß√£o Seletiva:');
          logProcessados('   ‚úÖ Anos importados: ' + infoReimportacao.anosImportados.join(', '));
          logProcessados('   üì¶ Anos preservados: ' + infoReimportacao.anosPreservados.join(', '));
        }

        console.log('=== IMPORTA√á√ÉO CONCLU√çDA ===');
        console.log('Tempo total:', tempoSeg + 's');
        console.log('Total de registros:', total.toLocaleString());
        console.log('Categorias importadas:', resumo.length);

        registrarImportacao(
          'despesas-processados',
          'Importa√ß√£o de Despesas (arquivos j√° processados)',
          total,
          'Pasta/Arquivos processados'
        );

        mostrarStatus('Importa√ß√£o conclu√≠da! ' + total.toLocaleString() + ' registros em ' + tempoSeg + 's.', 'success');

        // Construir mensagem com informa√ß√µes de reimporta√ß√£o seletiva
        var mensagem = 'IMPORTA√á√ÉO DE ARQUIVOS PROCESSADOS CONCLU√çDA!\n\n' +
                      total.toLocaleString() + ' registros importados em ' + tempoSeg + 's:\n\n' +
                      resumo.join('\n');

        if (infoReimportacao.ativa) {
          mensagem += '\n\nüîÑ REIMPORTA√á√ÉO SELETIVA:';
          mensagem += '\n‚úÖ Anos importados: ' + infoReimportacao.anosImportados.join(', ');
          mensagem += '\nüì¶ Anos preservados: ' + infoReimportacao.anosPreservados.join(', ');
          mensagem += '\n   (' + infoReimportacao.registrosPreservados.toLocaleString() + ' registros mantidos)';
        }

        alert(mensagem);
      } catch (e) {
        stopProcessadosTimer();
        console.error('Erro na importa√ß√£o de processados:', e);
        logProcessados('');
        logProcessados('‚ùå ERRO: ' + e.message);
        mostrarStatus('Erro na importa√ß√£o de processados: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
      }
    }

    // =====================================================
    // Pipeline: Upload e detec√ß√£o de planilhas brutas
    // =====================================================
    // =====================================================
    // Pipeline: Detec√ß√£o com suporte a m√∫ltiplos anos
    // =====================================================
    var brutosPorAno = {};   // { '2024': { matches, missing }, '2025': {...} }
    var brutosAnos = [];     // ['2024', '2025'] ou ['_unico']
    var anosReimportar = []; // Anos selecionados pelo usu√°rio para reimportar

    document.getElementById('brutosFolder').addEventListener('change', function(e) {
      var files = Array.from(e.target.files).filter(function(f) {
        var n = f.name.toLowerCase();
        return (n.endsWith('.xlsx') || n.endsWith('.xls') || n.endsWith('.xlsm')) && !n.startsWith('~$');
      });
      detectarArquivosBrutos(files, true);
    });

    document.getElementById('brutosFiles').addEventListener('change', function(e) {
      var files = Array.from(e.target.files);
      detectarArquivosBrutos(files, false);
    });

    function agruparArquivosPorAno(files) {
      var porAno = {};
      var semAno = [];
      for (var i = 0; i < files.length; i++) {
        var f = files[i];
        var relPath = f.webkitRelativePath || '';
        var parts = relPath.split('/');
        var subFolder = parts.length >= 3 ? parts[1] : null;
        if (subFolder && /^\d{4}$/.test(subFolder)) {
          if (!porAno[subFolder]) porAno[subFolder] = [];
          porAno[subFolder].push(f);
        } else {
          semAno.push(f);
        }
      }
      var anos = Object.keys(porAno).sort();
      if (anos.length === 0) return { '_unico': semAno };
      return porAno;
    }

    // Atualizar lista de anos selecionados para reimportar
    function atualizarAnosReimportar() {
      anosReimportar = [];
      for (var a = 0; a < brutosAnos.length; a++) {
        var ano = brutosAnos[a];
        var checkbox = document.getElementById('checkAno_' + ano);
        if (checkbox && checkbox.checked) {
          anosReimportar.push(ano);
        }
      }

      // Mostrar quais anos ser√£o preservados
      var anosPreservados = brutosAnos.filter(function(ano) {
        return !anosReimportar.includes(ano) && ano !== '_unico';
      });

      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üìã SELE√á√ÉO DE ANOS ATUALIZADA');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('‚úÖ Anos que ser√£o IMPORTADOS:', anosReimportar.join(', ') || 'nenhum');
      console.log('üì¶ Anos que ser√£o PRESERVADOS:', anosPreservados.join(', ') || 'nenhum');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    }

    function detectarArquivosBrutos(files, isPasta) {
      if (!files || files.length === 0) {
        mostrarStatus('Nenhum arquivo selecionado.', 'error');
        return;
      }
      if (typeof autoDetectarArquivos !== 'function') {
        mostrarStatus('ERRO: Scripts do pipeline n√£o carregaram. Recarregue a p√°gina.', 'error');
        return;
      }

      // CORRE√á√ÉO: Resetar sele√ß√£o de anos ao detectar novos arquivos
      anosReimportar = [];
      brutosPorAno = {};
      if (isPasta) {
        var grupos = agruparArquivosPorAno(files);
        var anos = Object.keys(grupos).sort();
        for (var i = 0; i < anos.length; i++) {
          brutosPorAno[anos[i]] = autoDetectarArquivos(grupos[anos[i]]);
        }
        brutosAnos = anos;
      } else {
        brutosPorAno['_unico'] = autoDetectarArquivos(files);
        brutosAnos = ['_unico'];
      }

      renderDeteccaoMultiAno();
    }

    function renderDeteccaoMultiAno() {
      var container = document.getElementById('brutosDeteccao');
      var html = '';
      var todosOk = true;
      var errosGlobal = [];

      // CORRE√á√ÉO: Inicializar anosReimportar apenas se estiver vazio
      if (anosReimportar.length === 0) {
        anosReimportar = brutosAnos.slice();
        console.log('Inicializando anosReimportar com todos os anos:', anosReimportar);
      }

      // Tags de ano com checkboxes para sele√ß√£o
      if (brutosAnos.length > 1 || (brutosAnos.length === 1 && brutosAnos[0] !== '_unico')) {
        html += '<div style="margin:12px 0;padding:12px;background:#f8f9fa;border-radius:10px;border:1px solid #e2e8f0;">';
        html += '<div style="font-weight:600;color:#334155;margin-bottom:8px;font-size:13px;">üìÖ Selecione os anos para importar/reimportar:</div>';
        html += '<div style="display:flex;gap:12px;flex-wrap:wrap;">';
        for (var a = 0; a < brutosAnos.length; a++) {
          var ano = brutosAnos[a];
          var label = ano === '_unico' ? 'Ano √∫nico' : ano;
          var checkId = 'checkAno_' + ano;
          // CORRE√á√ÉO: Respeitar o estado atual de anosReimportar
          var isChecked = anosReimportar.includes(ano);
          var checkedAttr = isChecked ? 'checked' : '';
          html += '<label style="display:flex;align-items:center;gap:6px;background:#fff;padding:8px 14px;border-radius:8px;border:1px solid #c4b5fd;cursor:pointer;">';
          html += '<input type="checkbox" id="' + checkId + '" value="' + ano + '" ' + checkedAttr + ' onchange="atualizarAnosReimportar()" style="cursor:pointer;">';
          html += '<span style="color:#6d28d9;font-weight:600;font-size:13px;">' + label + '</span>';
          html += '</label>';
        }
        html += '</div>';
        html += '<div style="margin-top:8px;font-size:12px;color:#64748b;">üí° Desmarque anos que j√° est√£o importados e n√£o precisam ser atualizados</div>';
        html += '</div>';
      }

      for (var a = 0; a < brutosAnos.length; a++) {
        var ano = brutosAnos[a];
        var result = brutosPorAno[ano];
        var anoLabel = ano === '_unico' ? 'Ano √∫nico' : ano;

        if (brutosAnos.length > 1) {
          html += '<div style="margin:12px 0;padding:12px;border:1px solid #e2e8f0;border-radius:10px;background:#fafbfc;">';
          html += '<div style="font-size:14px;font-weight:700;color:#334155;margin-bottom:8px;">';
          html += '<span style="background:#7c3aed;color:white;font-size:12px;padding:2px 10px;border-radius:10px;margin-right:8px;">' + anoLabel + '</span>';
          var okCount = Object.keys(result.matches).length;
          html += okCount + '/' + _CRUZAR_ALVOS.length + ' arquivos</div>';
        }

        html += '<div class="file-grid-detect">';
        for (var i = 0; i < _CRUZAR_ALVOS.length; i++) {
          var alvo = _CRUZAR_ALVOS[i];
          var file = result.matches[alvo.role];
          var ok = !!file;
          var cls = ok ? 'ok' : (alvo.obrigatorio ? 'err' : 'warn');
          html += '<div class="file-slot ' + cls + '">';
          html += '<span class="role">' + alvo.label + ':</span>';
          if (ok) {
            html += '<span class="fname">' + file.name + '</span>';
          } else {
            html += '<span class="missing">' + (alvo.obrigatorio ? 'n√£o encontrado' : 'opcional') + '</span>';
          }
          html += '</div>';
        }
        html += '</div>';

        if (brutosAnos.length > 1) html += '</div>';

        if (result.missing && result.missing.length > 0) {
          todosOk = false;
          errosGlobal.push(anoLabel + ': ' + result.missing.join(', '));
        }
      }

      container.innerHTML = html;

      var btnArea = document.getElementById('brutosBotaoProcessar');
      if (todosOk) {
        btnArea.style.display = '';
        var msg = 'Todos os arquivos obrigat√≥rios detectados!';
        if (brutosAnos.length > 1) msg += ' Anos: ' + brutosAnos.join(', ') + '.';
        mostrarStatus(msg, 'success');
      } else {
        btnArea.style.display = 'none';
        mostrarStatus('Faltando: ' + errosGlobal.join(' | '), 'error');
      }
    }

    // =====================================================
    // Pipeline: Transforma√ß√£o + Cruzamento + Importa√ß√£o
    // =====================================================
    // Mapeamento de roles do pipeline para transforma√ß√µes V2 (lazy ‚Äî avalia na hora de usar)
    function getPipelineTransformacao(role) {
      var mapa = {
        'liquidados':   { fn: window.transformarLiquidados,   label: 'Liquidados' },
        'pagos':        { fn: window.transformarPagos,         label: 'Pagos' },
        'emitidos':     { fn: window.transformarEmitidos,      label: 'Emitidos' },
        'aPagar':       { fn: window.transformarAPagar,        label: 'A Pagar' },
        'consignados':  { fn: window.transformarConsignados,   label: 'Consignados' },
        'credores':     { fn: window.transformarCredores,      label: 'Credores' },
        'detalhamento': { fn: window.transformarDetalhamento,  label: 'Detalhamento' }
      };
      return mapa[role] || null;
    }

    // Mapeamento: nome da aba do cruzamento √¢‚Ä†‚Äô store do IndexedDB
    var MAPA_ABA_STORE = {
      'Emp. Liquidados':  'despesas-liquidados',
      'Emp. Pagos':       'despesas-pagos',
      'Emp. Emitidos':    'despesas-empenhados',
      'Empenhos a pagar': 'despesas-a-pagar',
      'Empenhos retidos': 'despesas-retidos'
    };

    function pipelineSleep(ms) {
      return new Promise(function(r) { setTimeout(r, ms); });
    }

    function logPipeline(msg) {
      var el = document.getElementById('brutosPhaseLog');
      el.style.display = '';
      var line = document.createElement('div');
      line.className = 'phase-line-pipe';
      line.textContent = msg;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }

    function setPipelineProgress(pct) {
      document.getElementById('brutosProgressBar').style.display = '';
      document.getElementById('brutosProgressFill').style.width = pct + '%';
    }

    // Controle do temporizador em tempo real para processados
    var processadosTimerInterval = null;
    var processadosTimerStartTime = 0;

    function startProcessadosTimer() {
      processadosTimerStartTime = performance.now();
      document.getElementById('processadosTimer').style.display = '';
      document.getElementById('processadosTimerValue').textContent = '00:00';

      processadosTimerInterval = setInterval(function() {
        var elapsed = Math.floor((performance.now() - processadosTimerStartTime) / 1000);
        var minutes = Math.floor(elapsed / 60);
        var seconds = elapsed % 60;
        var display = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        document.getElementById('processadosTimerValue').textContent = display;
      }, 1000);
    }

    function stopProcessadosTimer() {
      if (processadosTimerInterval) {
        clearInterval(processadosTimerInterval);
        processadosTimerInterval = null;
      }
    }

    function getProcessadosElapsedTime() {
      return ((performance.now() - processadosTimerStartTime) / 1000).toFixed(1);
    }

    function setProcessadosProgress(pct) {
      document.getElementById('processadosProgressBar').style.display = '';
      document.getElementById('processadosProgressFill').style.width = pct + '%';
    }

    function logProcessados(msg) {
      var el = document.getElementById('processadosLog');
      el.style.display = '';
      var line = document.createElement('div');
      line.className = 'phase-line-pipe';
      line.textContent = msg;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }

    // Converter matrix (2D array com header) √¢‚Ä†' array de objetos
    // Vers√£o ass√≠ncrona que processa em chunks para evitar travar o navegador
    // Vers√£o otimizada para grandes volumes (500k+ linhas)
    async function matrixParaObjetosAsync(matrix) {
      if (!matrix || matrix.length < 2) return [];
      var headers = matrix[0];
      var totalRows = matrix.length - 1;
      var objetos = new Array(totalRows); // Pr√©-alocar array para performance
      var CHUNK_SIZE = 5000; // Chunks maiores = menos yields = mais r√°pido

      for (var startRow = 1; startRow < matrix.length; startRow += CHUNK_SIZE) {
        var endRow = Math.min(startRow + CHUNK_SIZE, matrix.length);

        // Processar chunk (otimizado: menos checks)
        for (var r = startRow; r < endRow; r++) {
          var row = matrix[r];
          var obj = {};
          for (var c = 0; c < headers.length; c++) {
            var key = headers[c];
            if (key != null && String(key).trim()) {
              obj[key] = c < row.length ? row[c] : '';
            }
          }
          objetos[r - 1] = obj; // √çndice direto ao inv√©s de push
        }

        // Yield apenas a cada 5000 linhas para manter responsividade sem perder performance
        if (endRow < matrix.length && (endRow % 25000 === 0)) {
          await pipelineSleep(0); // Yield apenas a cada 25k linhas processadas
        }
      }
      return objetos;
    }

    // Mant√©m vers√£o s√≠ncrona para compatibilidade (mas n√£o usar em matrizes grandes)
    function matrixParaObjetos(matrix) {
      if (!matrix || matrix.length < 2) return [];
      var headers = matrix[0];
      var objetos = [];
      for (var r = 1; r < matrix.length; r++) {
        var row = matrix[r];
        var obj = {};
        for (var c = 0; c < headers.length; c++) {
          var key = headers[c];
          if (key != null && String(key).trim()) {
            obj[key] = c < row.length ? row[c] : '';
          }
        }
        objetos.push(obj);
      }
      return objetos;
    }

    // =====================================================
    // Web Worker para parse paralelo de XLSX
    // =====================================================
    var _xlsxWorkerBlob = null;
    var _xlsxWorkerUrl = null;

    function criarXlsxWorkerUrl() {
      if (_xlsxWorkerUrl) return _xlsxWorkerUrl;
      var code = [
        'importScripts("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js");',
        'self.onmessage = function(e) {',
        '  try {',
        '    var wb = XLSX.read(e.data.buffer, {',
        '      type: "array",',
        '      cellFormula: false,',
        '      cellStyles: false,',
        '      cellHTML: false,',
        '      cellNF: false,',
        '      cellDates: false',
        '    });',
        '    var result = { SheetNames: wb.SheetNames, Sheets: {} };',
        '    for (var i = 0; i < wb.SheetNames.length; i++) {',
        '      var name = wb.SheetNames[i];',
        '      result.Sheets[name] = wb.Sheets[name];',
        '    }',
        '    self.postMessage({ role: e.data.role, workbook: result });',
        '  } catch(err) {',
        '    self.postMessage({ role: e.data.role, error: err.message });',
        '  }',
        '};'
      ].join('\n');
      _xlsxWorkerBlob = new Blob([code], { type: 'application/javascript' });
      _xlsxWorkerUrl = URL.createObjectURL(_xlsxWorkerBlob);
      return _xlsxWorkerUrl;
    }

    function parsearComWorker(buffer, role) {
      return new Promise(function(resolve, reject) {
        var worker = new Worker(criarXlsxWorkerUrl());
        worker.onmessage = function(e) {
          worker.terminate();
          if (e.data.error) {
            reject(new Error('[Worker ' + role + '] ' + e.data.error));
          } else {
            resolve(e.data.workbook);
          }
        };
        worker.onerror = function(err) {
          worker.terminate();
          reject(new Error('[Worker ' + role + '] ' + (err.message || 'Erro no worker')));
        };
        // Transferir buffer (zero-copy)
        worker.postMessage({ role: role, buffer: buffer }, [buffer]);
      });
    }

    // =====================================================
    // Processar um ano: ler, parsear em paralelo, transformar, cruzar
    // OTIMIZADO: Web Workers para parse paralelo de XLSX
    // =====================================================
    async function processarUmAnoPipeline(anoLabel, arquivos) {
      var matrices = {};
      var roles = ['liquidados', 'pagos', 'emitidos', 'aPagar', 'consignados', 'credores', 'simples', 'balancete', 'detalhamento'];

      // --- Fase 1: Leitura de buffers em paralelo ---
      var tLeitura = performance.now();
      logPipeline('  Lendo arquivos...');
      var buffers = {};
      var readPromises = [];
      for (var i = 0; i < roles.length; i++) {
        var role = roles[i];
        var file = arquivos[role];
        if (!file && role === 'simples') {
          buffers[role] = null;
          continue;
        }
        if (!file) throw new Error('[' + anoLabel + '] Arquivo n√£o encontrado: ' + role);
        (function(r, f) {
          readPromises.push(f.arrayBuffer().then(function(buf) { buffers[r] = buf; }));
        })(role, file);
      }
      await Promise.all(readPromises);
      var tempoLeitura = ((performance.now() - tLeitura) / 1000).toFixed(2);
      logPipeline('    ‚Üí Arquivos lidos em ' + tempoLeitura + 's');

      // --- Fase 2: Parse XLSX em paralelo via Web Workers ---
      var tParse = performance.now();
      logPipeline('  Parseando XLSX em paralelo (Web Workers)...');
      var workbooks = {};
      var parsePromises = [];
      var workerSupported = typeof Worker !== 'undefined';

      if (workerSupported) {
        // Parse paralelo com Web Workers
        for (var i = 0; i < roles.length; i++) {
          var role = roles[i];
          if (role === 'simples' && !buffers[role]) {
            workbooks[role] = null;
            continue;
          }
          (function(r) {
            var buf = buffers[r];
            buffers[r] = null; // liberar refer√™ncia
            parsePromises.push(
              parsearComWorker(buf, r).then(function(wb) {
                workbooks[r] = wb;
              })
            );
          })(role);
        }
        await Promise.all(parsePromises);
      } else {
        // Fallback: parse sequencial no main thread
        logPipeline('    (Web Workers n√£o dispon√≠veis, usando parse sequencial)');
        for (var i = 0; i < roles.length; i++) {
          var role = roles[i];
          if (role === 'simples' && !buffers[role]) {
            workbooks[role] = null;
            continue;
          }
          workbooks[role] = XLSX.read(buffers[role], {
            type: 'array',
            cellFormula: false,
            cellStyles: false,
            cellHTML: false,
            cellNF: false,
            cellDates: false
          });
          buffers[role] = null;
        }
      }
      buffers = null;
      var tempoParse = ((performance.now() - tParse) / 1000).toFixed(2);
      logPipeline('    ‚Üí Parse conclu√≠do em ' + tempoParse + 's' + (workerSupported ? ' (paralelo)' : ' (sequencial)'));

      // --- Fase 3: Transforma√ß√µes (main thread, sequencial) ---
      var tTransf = performance.now();
      for (var i = 0; i < roles.length; i++) {
        var role = roles[i];
        if (role === 'simples' && !workbooks[role]) {
          matrices[role] = null;
          logPipeline('  Simples Nacional n√£o fornecido ‚Äî ser√° pulado.');
          continue;
        }

        await pipelineSleep(0); // Yield ao navegador

        var wb = workbooks[role];
        workbooks[role] = null; // liberar

        var transf = getPipelineTransformacao(role);
        if (transf && transf.fn) {
          var tRole = performance.now();
          logPipeline('  Transformando ' + transf.label + '...');
          var resultado = transf.fn(wb);
          matrices[role] = resultado.matrix;
          var stats = resultado.stats || {};
          var tempoRole = ((performance.now() - tRole) / 1000).toFixed(2);
          logPipeline('    ‚Üí ' + transf.label + ': ' + (stats.linhasFinal || (matrices[role] ? matrices[role].length - 1 : '?')) + ' linhas (' + tempoRole + 's)');
          wb = null; resultado = null;
        } else {
          var tRole = performance.now();
          var sheet = wb.Sheets[wb.SheetNames[0]];
          matrices[role] = sheetToMatrix(sheet, { raw: false, defval: '' });
          var tempoRole = ((performance.now() - tRole) / 1000).toFixed(2);
          logPipeline('    ‚Üí ' + role + ': ' + (matrices[role].length - 1) + ' linhas (' + tempoRole + 's)');
          wb = null;
        }
      }
      workbooks = null;
      var tempoTransf = ((performance.now() - tTransf) / 1000).toFixed(2);
      logPipeline('  Transforma√ß√µes: ' + tempoTransf + 's | Parse: ' + tempoParse + 's | Leitura: ' + tempoLeitura + 's');

      // Yield ao navegador ANTES do cruzamento (opera√ß√£o mais pesada de todas)
      var tCruz = performance.now();
      logPipeline('  Executando cruzamentos V2...');
      await pipelineSleep(50);

      // V2: retorna matrizes leves
      var result = executarCruzamento(matrices, null, function(fase, msg) {
        logPipeline('    [Fase ' + fase + '] ' + msg);
      }, { skipRetidos: true, returnMatricesOnly: true });

      var tempoCruz = ((performance.now() - tCruz) / 1000).toFixed(2);
      logPipeline('  Cruzamento conclu√≠do em ' + tempoCruz + 's');

      for (var k in matrices) matrices[k] = null;
      matrices = null;

      return result.abas; // Array de { nome, matrix }
    }

    // Empilhar matrizes de m√∫ltiplos anos
    // OTIMIZADO: usar concat em vez de push individual
    function empilharAbas(acumulado, novasAbas) {
      if (!acumulado) return novasAbas;

      var t0 = performance.now();
      for (var s = 0; s < acumulado.length; s++) {
        var nova = novasAbas[s];
        if (!nova || !nova.matrix || nova.matrix.length < 2) continue;

        // OTIMIZA√á√ÉO: Array.concat √© muito mais r√°pido que push individual
        var linhasNovas = nova.matrix.slice(1); // Remove header
        acumulado[s].matrix = acumulado[s].matrix.concat(linhasNovas);

        nova.matrix = null;
        linhasNovas = null;
      }
      var tempo = ((performance.now() - t0) / 1000).toFixed(2);
      console.log('‚ö° Empilhamento de abas: ' + tempo + 's');

      return acumulado;
    }

    // =====================================================
    // Processar Brutos: itera sobre anos, empilha, salva
    // =====================================================
    async function processarBrutos() {
      if (brutosAnos.length === 0) return;

      // Validar que pelo menos um ano est√° selecionado
      if (anosReimportar.length === 0) {
        alert('Selecione pelo menos um ano para importar!');
        return;
      }

      document.getElementById('btnProcessarBrutos').disabled = true;
      document.getElementById('brutosPhaseLog').innerHTML = '';
      setPipelineProgress(2);
      // Resetar informa√ß√µes de reimporta√ß√£o
      infoReimportacao = { ativa: false, anosImportados: [], anosPreservados: [], registrosPreservados: 0 };

      try {
        logPipeline('=== Iniciando Pipeline V2 ===');

        // Informar sobre reimporta√ß√£o seletiva
        if (anosReimportar.length < brutosAnos.length && brutosAnos[0] !== '_unico') {
          var anosNaoSelecionados = brutosAnos.filter(function(ano) {
            return !anosReimportar.includes(ano);
          });
          logPipeline('üîÑ REIMPORTA√á√ÉO SELETIVA:');
          logPipeline('   ‚úÖ Importando: ' + anosReimportar.join(', '));
          logPipeline('   üì¶ Preservando: ' + anosNaoSelecionados.join(', '));
          logPipeline('');
        }

        var t0 = performance.now();
        var abasAcumuladas = null;
        var totalAnos = brutosAnos.length;

        for (var a = 0; a < totalAnos; a++) {
          var ano = brutosAnos[a];
          var anoLabel = ano === '_unico' ? 'Ano √∫nico' : ano;
          var arquivos = brutosPorAno[ano].matches;

          var pctBase = Math.round((a / totalAnos) * 80);
          setPipelineProgress(2 + pctBase);

          logPipeline('');
          logPipeline('========================================');
          logPipeline('  ANO: ' + anoLabel + ' (' + (a + 1) + '/' + totalAnos + ')');
          logPipeline('========================================');

          var tAno = performance.now();
          var abasAno = await processarUmAnoPipeline(anoLabel, arquivos);
          var tempoAno = ((performance.now() - tAno) / 1000).toFixed(1);

          abasAcumuladas = empilharAbas(abasAcumuladas, abasAno);
          abasAno = null;

          logPipeline('  ‚Üí ' + anoLabel + ' conclu√≠do em ' + tempoAno + 's!');
          console.log('üìÖ Ano ' + anoLabel + ' processado em ' + tempoAno + 's');
          await pipelineSleep(5);
        }

        setPipelineProgress(85);
        logPipeline('');
        logPipeline('=== Salvando no Banco de Dados ===');

        // Converter matrizes acumuladas √¢‚Ä†‚Äô objetos √¢‚Ä†‚Äô IndexedDB
        var resumoImportacao = [];
        var totalGeral = 0;
        var anosStr = totalAnos > 1 ? ' (' + brutosAnos.join(', ') + ')' : '';
        var nomeArquivo = 'Pipeline V2 Autom√°tico' + anosStr;

        for (var s = 0; s < abasAcumuladas.length; s++) {
          var aba = abasAcumuladas[s];
          var storeName = MAPA_ABA_STORE[aba.nome];

          if (!storeName) {
            logPipeline('  Aba "' + aba.nome + '" sem store, pulando.');
            continue;
          }

          logPipeline('  Salvando ' + aba.nome + ' ‚Üí ' + storeName + '...');
          setPipelineProgress(85 + Math.round(((s + 1) / abasAcumuladas.length) * 13));

          // Yield ao navegador antes da convers√£o pesada
          // Converter matrix √¢‚Ä†‚Äô array de objetos
          // N√ÉO aplicar converterDatasArray: o pipeline V2 j√° retorna datas formatadas como strings.
          // converterDatasArray corrompe valores monet√°rios entre 40000-60000 convertendo-os em datas.
          var dados = await matrixParaObjetosAsync(aba.matrix);
          aba.matrix = null; // liberar matrix original ap√≥s converter

          // Yield antes de salvar no DB

          var tStore = performance.now();

          // CORRE√á√ÉO: 3 casos distintos de importa√ß√£o
          // Caso A: M√∫ltiplas pastas + TODOS os anos selecionados ‚Üí N√ÉO preservar nada (limpar e salvar)
          // Caso B: M√∫ltiplas pastas + ALGUNS anos desmarcados ‚Üí preservar anos desmarcados (manual)
          // Caso C: Pasta √∫nica (_unico) ‚Üí detec√ß√£o autom√°tica de anos (preservar outros)
          var anosParam;
          var todosAnosDePastas = (brutosAnos.length > 1 && brutosAnos[0] !== '_unico' && anosReimportar.length === brutosAnos.length);

          if (todosAnosDePastas) {
            // Caso A: Importando todos os anos ‚Üí sem preserva√ß√£o, substituir tudo
            anosParam = '__REPLACE_ALL__';
            console.log('üìã Caso A: Todos os anos selecionados ‚Üí substituir tudo');
          } else if (brutosAnos[0] === '_unico') {
            // Caso C: Pasta √∫nica ‚Üí detec√ß√£o autom√°tica
            anosParam = null;
            console.log('üìã Caso C: Pasta √∫nica ‚Üí detec√ß√£o autom√°tica de anos');
          } else {
            // Caso B: Alguns anos desmarcados ‚Üí preserva√ß√£o manual
            anosParam = anosReimportar;
            console.log('üìã Caso B: Anos selecionados manualmente:', anosReimportar);
          }

          await salvarDadosDB(storeName, dados, anosParam);
          var tempoStore = ((performance.now() - tStore) / 1000).toFixed(1);

          var nomeTipo = storeName.replace('despesas-', 'Despesas ').replace('-', ' ');
          resumoImportacao.push('‚úì ' + nomeTipo + ': ' + dados.length.toLocaleString() + ' registros');
          totalGeral += dados.length;

          logPipeline('    ‚Üí ' + dados.length.toLocaleString() + ' registros salvos em ' + tempoStore + 's');
          dados = null;
        }

        abasAcumuladas = null;

        // Registrar no hist√≥rico
        registrarImportacao(
          'despesas-pipeline-v2',
          'Pipeline V2 (brutas -> transformacao -> cruzamento)' + anosStr,
          totalGeral,
          nomeArquivo
        );

        var tempoSeg = ((performance.now() - t0) / 1000).toFixed(1);
        setPipelineProgress(100);
        logPipeline('');
        logPipeline('=== Pipeline conclu√≠do em ' + tempoSeg + 's! ===');
        logPipeline('Total: ' + totalGeral.toLocaleString() + ' registros importados.' + anosStr);

        // Mensagem de reimporta√ß√£o seletiva
        var msgSeletiva = '';
        if (anosReimportar.length < brutosAnos.length && brutosAnos[0] !== '_unico') {
          var anosNaoSelecionados = brutosAnos.filter(function(ano) {
            return !anosReimportar.includes(ano);
          });
          msgSeletiva = '\n\nüîÑ Reimporta√ß√£o seletiva:\n‚úÖ Importados: ' + anosReimportar.join(', ') + '\nüì¶ Preservados: ' + anosNaoSelecionados.join(', ');
          logPipeline('');
          logPipeline('üîÑ Anos preservados: ' + anosNaoSelecionados.join(', '));
        }

        mostrarStatus(
          'Importa√ß√£o via Pipeline V2 conclu√≠da! ' + totalGeral.toLocaleString() + ' registros em ' + tempoSeg + 's.' + anosStr,
          'success'
        );

        alert(
          'IMPORTA√á√ÉO VIA PIPELINE V2 CONCLU√çDA!\n\n' +
          totalGeral.toLocaleString() + ' registros importados' + anosStr + ':\n\n' +
          resumoImportacao.join('\n') +
          msgSeletiva +
          '\n\nAgora voc√™ pode acessar as p√°ginas de despesas para visualizar os dados.'
        );

      } catch (e) {
        console.error('Erro no pipeline:', e);
        logPipeline('ERRO: ' + e.message);
        mostrarStatus('ERRO no pipeline: ' + e.message, 'error');
      }

      document.getElementById('btnProcessarBrutos').disabled = false;
    }
  </script>
</body>
</html>


