<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGEF | Login</title>
  <link rel="icon" type="image/png" href="img/brasao-caruaru.png">
  <style>
    :root {
      --brand-900: #1a5a2e;
      --brand-800: #1f6a35;
      --brand-700: #238c3e;
      --brand-500: #2ea44f;
      --bg-card: #ffffff;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #dbe3ec;
      --danger: #b91c1c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      background: radial-gradient(circle at 15% 20%, rgba(255, 255, 255, 0.18), transparent 35%),
                  radial-gradient(circle at 90% 90%, rgba(255, 255, 255, 0.12), transparent 30%),
                  linear-gradient(140deg, var(--brand-900), var(--brand-800) 45%, var(--brand-700));
      display: grid;
      place-items: center;
      padding: 24px;
      color: var(--text);
    }

    .login-wrap {
      width: 100%;
      max-width: 420px;
    }

    .brand {
      text-align: center;
      margin-bottom: 16px;
      color: #ffffff;
    }

    .brand img {
      width: 92px;
      height: 92px;
      object-fit: contain;
      display: block;
      margin: 0 auto 10px;
      filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.25));
    }

    .brand h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 1px;
    }

    .brand p {
      margin: 6px 0 0;
      color: rgba(255, 255, 255, 0.85);
      font-size: 13px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 22px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.22);
    }

    .field {
      margin-bottom: 14px;
    }

    .field label {
      display: block;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .field input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 11px 12px;
      font-size: 14px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    .field input:focus {
      border-color: var(--brand-500);
      box-shadow: 0 0 0 3px rgba(46, 164, 79, 0.15);
    }

    .btn {
      width: 100%;
      border: 0;
      border-radius: 10px;
      padding: 11px 12px;
      background: linear-gradient(180deg, #33b45a, #249746);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    .btn:disabled {
      opacity: .65;
      cursor: not-allowed;
    }

    .error {
      display: none;
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
      color: var(--danger);
      background: #fee2e2;
      border: 1px solid #fecaca;
    }

    .footer {
      margin-top: 12px;
      text-align: center;
      color: rgba(255, 255, 255, 0.85);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="login-wrap">
    <div class="brand">
      <img src="img/brasao-caruaru.png" alt="Brasão Caruaru">
      <h1>SIGEF Caruaru</h1>
      <p>Sistema de Gestão Financeira</p>
    </div>

    <div class="card">
      <form id="loginForm">
        <div id="errorBox" class="error"></div>

        <div class="field">
          <label for="username">Usuário</label>
          <input id="username" name="username" type="text" autocomplete="username" required>
        </div>

        <div class="field">
          <label for="password">Senha</label>
          <input id="password" name="password" type="password" autocomplete="current-password" required>
        </div>

        <button id="btnLogin" class="btn" type="submit">Entrar</button>
      </form>
    </div>

    <div class="footer">Prefeitura Municipal de Caruaru - SEFAZ</div>
  </div>

  <script>
    (function () {
      var form = document.getElementById('loginForm');
      var btn = document.getElementById('btnLogin');
      var errorBox = document.getElementById('errorBox');

      // Chave para armazenar usuários no localStorage
      var USUARIOS_KEY = 'sigef_usuarios';

      // Carrega usuários do localStorage ou cria os padrões
      function carregarUsuarios() {
        try {
          var data = localStorage.getItem(USUARIOS_KEY);
          if (data) {
            return JSON.parse(data);
          }
        } catch (e) {
          console.error('Erro ao carregar usuários:', e);
        }

        // Cria usuários padrão se não existirem
        var usuariosPadrao = [
          {
            id: 1,
            username: 'admin',
            password: 'admin123',
            nome: 'Administrador',
            email: 'admin@caruaru.pe.gov.br',
            perfil: 'Administrador',
            role: 'admin',
            setor: 'SEFAZ',
            active: true,
            created_at: Date.now()
          },
          {
            id: 2,
            username: 'gestor',
            password: 'gestor123',
            nome: 'Gestor Financeiro',
            email: 'gestor@caruaru.pe.gov.br',
            perfil: 'Gestor',
            role: 'user',
            setor: 'SEFAZ',
            active: true,
            created_at: Date.now()
          },
          {
            id: 3,
            username: 'usuario',
            password: 'usuario123',
            nome: 'Usuário',
            email: 'usuario@caruaru.pe.gov.br',
            perfil: 'Consulta',
            role: 'user',
            setor: 'SEFAZ',
            active: true,
            created_at: Date.now()
          }
        ];

        try {
          localStorage.setItem(USUARIOS_KEY, JSON.stringify(usuariosPadrao));
        } catch (e) {
          console.error('Erro ao salvar usuários padrão:', e);
        }

        return usuariosPadrao;
      }

      var usuarios = carregarUsuarios();

      function mostrarErro(msg) {
        errorBox.textContent = msg;
        errorBox.style.display = 'block';
      }

      function esconderErro() {
        errorBox.textContent = '';
        errorBox.style.display = 'none';
      }

      function gerarToken() {
        return 'token_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
      }

      // Verifica se já está autenticado
      try {
        var token = localStorage.getItem('auth_token');
        var authTime = Number(localStorage.getItem('auth_time') || '0');
        if (token && authTime) {
          var horas = (Date.now() - authTime) / (1000 * 60 * 60);
          if (horas < 24) {
            window.location.href = 'dashboard.html';
            return;
          }
        }
      } catch (e) {}

      // Mostra mensagem de sessão (se houver)
      try {
        var authMessage = sessionStorage.getItem('auth_message');
        if (authMessage) {
          mostrarErro(authMessage);
          sessionStorage.removeItem('auth_message');
        }
      } catch (e) {}

      form.addEventListener('submit', function (ev) {
        ev.preventDefault();
        esconderErro();

        var username = (document.getElementById('username').value || '').trim();
        var password = (document.getElementById('password').value || '').trim();

        if (!username || !password) {
          mostrarErro('Informe usuário e senha.');
          return;
        }

        btn.disabled = true;
        btn.textContent = 'Entrando...';

        // Simula delay de autenticação (opcional, para UX)
        setTimeout(function() {
          // Busca o usuário na lista
          var usuarioEncontrado = null;
          for (var i = 0; i < usuarios.length; i++) {
            if (usuarios[i].username === username && usuarios[i].password === password) {
              usuarioEncontrado = usuarios[i];
              break;
            }
          }

          if (!usuarioEncontrado) {
            mostrarErro('Usuário ou senha inválidos.');
            btn.disabled = false;
            btn.textContent = 'Entrar';
            return;
          }

          // Verifica se o usuário está ativo
          if (usuarioEncontrado.active === false) {
            mostrarErro('Este usuário está desativado. Contate o administrador.');
            btn.disabled = false;
            btn.textContent = 'Entrar';
            return;
          }

          // Autentica o usuário
          var token = gerarToken();
          var userData = {
            username: usuarioEncontrado.username,
            nome: usuarioEncontrado.nome,
            perfil: usuarioEncontrado.perfil,
            role: usuarioEncontrado.role || (usuarioEncontrado.perfil === 'Administrador' ? 'admin' : 'user'),
            setor: usuarioEncontrado.setor
          };

          console.log('[Login] Autenticando usuário:', usuarioEncontrado.username);
          console.log('[Login] Token gerado:', token);

          localStorage.setItem('auth_token', token);
          localStorage.setItem('auth_time', String(Date.now()));
          localStorage.setItem('user_data', JSON.stringify(userData));

          console.log('[Login] Dados salvos no localStorage');
          console.log('[Login] Verificando salvamento:');
          console.log('  - auth_token:', localStorage.getItem('auth_token') ? 'OK' : 'ERRO');
          console.log('  - auth_time:', localStorage.getItem('auth_time') ? 'OK' : 'ERRO');
          console.log('  - user_data:', localStorage.getItem('user_data') ? 'OK' : 'ERRO');

          // Redireciona para o dashboard
          console.log('[Login] Redirecionando para dashboard...');
          window.location.href = 'dashboard.html';
        }, 300);
      });
    })();
  </script>
</body>
</html>
