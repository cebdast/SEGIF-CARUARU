<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGEF | Histórico de Importações - Caruaru</title>
  <link rel="icon" type="image/png" href="https://caruaru.pe.gov.br/wp-content/uploads/2018/08/Brasao-231x300.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/portal-transparencia.css">
  <style>
    .ultima-importacao-card {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      border-radius: 16px;
      padding: 30px;
      color: white;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }
    .ultima-importacao-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 300px;
      height: 300px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }
    .ultima-importacao-card .icone {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.9;
    }
    .ultima-importacao-card h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    .ultima-importacao-card .data-principal {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .ultima-importacao-card .detalhes {
      font-size: 14px;
      opacity: 0.9;
    }
    .ultima-importacao-card .sem-dados {
      font-size: 18px;
      opacity: 0.8;
    }
    
    .stats-resumo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-mini {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #e2e8f0;
      text-align: center;
    }
    .stat-mini i {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .stat-mini.despesas i { color: #059669; }
    .stat-mini.receitas i { color: #2563eb; }
    .stat-mini.total i { color: #8b5cf6; }
    .stat-mini .valor {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-dark);
    }
    .stat-mini .label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .historico-lista {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .historico-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all 0.3s ease;
    }
    .historico-item:hover {
      border-color: var(--color-primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .historico-item .icone-tipo {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .historico-item .icone-tipo.despesas {
      background: rgba(5, 150, 105, 0.1);
      color: #059669;
    }
    .historico-item .icone-tipo.receitas {
      background: rgba(37, 99, 235, 0.1);
      color: #2563eb;
    }
    .historico-item .info {
      flex: 1;
    }
    .historico-item .info h4 {
      font-size: 15px;
      color: var(--text-dark);
      margin-bottom: 4px;
    }
    .historico-item .info p {
      font-size: 13px;
      color: var(--text-muted);
      margin: 0;
    }
    .historico-item .data-hora {
      text-align: right;
    }
    .historico-item .data-hora .data {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
    }
    .historico-item .data-hora .hora {
      font-size: 12px;
      color: var(--text-muted);
    }
    .historico-item .registros {
      background: #f1f5f9;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .sem-historico {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .sem-historico i {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    .sem-historico h3 {
      font-size: 18px;
      color: var(--text-dark);
      margin-bottom: 10px;
    }
    .sem-historico p {
      font-size: 14px;
    }

    .btn-limpar {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fca5a5;
    }
    .btn-limpar:hover {
      background: #dc2626;
      color: white;
    }
  </style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="https://caruaru.pe.gov.br/wp-content/uploads/2018/08/Brasao-231x300.png" alt="Brasão Caruaru">
      </div>
      <h1 class="sidebar-title">Secretaria da Fazenda</h1>
      <button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-chevron-left"></i></button>
    </div>
    <nav class="sidebar-menu">
      <div class="menu-section">
        <div class="menu-section-title" onclick="toggleSection(this)">
          <i class="fas fa-hand-holding-usd"></i>
          <span>Receitas</span>
          <i class="fas fa-chevron-right section-arrow"></i>
        </div>
        <ul>
          <li class="menu-item"><a href="receitas-previsao.html" class="menu-link"><i class="fas fa-chart-line"></i><span>Previsão</span></a></li>
          <li class="menu-item"><a href="receitas-arrecadacao.html" class="menu-link"><i class="fas fa-money-bill-wave"></i><span>Arrecadação</span></a></li>
          <li class="menu-item"><a href="receitas-retencoes.html" class="menu-link"><i class="fas fa-hand-holding-usd"></i><span>Retenções</span></a></li>
          <li class="menu-item"><a href="receitas-deducoes.html" class="menu-link"><i class="fas fa-minus-circle"></i><span>Deduções</span></a></li>
          <li class="menu-item"><a href="receitas-gerencial.html" class="menu-link"><i class="fas fa-tachometer-alt"></i><span>Gerencial</span></a></li>
          <li class="menu-item"><a href="receitas-comparativos.html" class="menu-link"><i class="fas fa-balance-scale"></i><span>Comparativos</span></a></li>
        </ul>
      </div>
      <div class="menu-section">
        <div class="menu-section-title" onclick="toggleSection(this)">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Despesas</span>
          <i class="fas fa-chevron-right section-arrow"></i>
        </div>
        <ul>
          <li class="menu-item"><a href="despesas-empenhados.html" class="menu-link"><i class="fas fa-file-invoice"></i><span>Empenhados</span></a></li>
          <li class="menu-item"><a href="despesas-liquidados.html" class="menu-link"><i class="fas fa-check-circle"></i><span>Liquidados</span></a></li>
          <li class="menu-item"><a href="despesas-retidos.html" class="menu-link"><i class="fas fa-hand-holding-usd"></i><span>Retidos</span></a></li>
          <li class="menu-item"><a href="despesas-pagos.html" class="menu-link"><i class="fas fa-money-check-alt"></i><span>Pagos</span></a></li>
          <li class="menu-item"><a href="despesas-a-pagar.html" class="menu-link"><i class="fas fa-clock"></i><span>A Pagar</span></a></li>
          <li class="menu-item"><a href="despesas-gerencial.html" class="menu-link"><i class="fas fa-chart-line"></i><span>Gerencial</span></a></li>
          <li class="menu-item"><a href="despesas-comparativos.html" class="menu-link"><i class="fas fa-balance-scale"></i><span>Comparativos</span></a></li>
        </ul>
      </div>
      <div class="menu-section expanded">
        <div class="menu-section-title" onclick="toggleSection(this)">
          <i class="fas fa-database"></i>
          <span>Banco de Dados</span>
          <i class="fas fa-chevron-right section-arrow"></i>
        </div>
        <ul>
          <li class="menu-item"><a href="banco-importar-dados.html" class="menu-link"><i class="fas fa-file-import"></i><span>Importar Dados</span></a></li>
          <li class="menu-item"><a href="banco-historico.html" class="menu-link active"><i class="fas fa-history"></i><span>Histórico</span></a></li>
        </ul>
      </div>
    </nav>
  </aside>
  <div class="sidebar-overlay" onclick="closeSidebar()"></div>
  <div class="main-wrapper">
    <header class="top-header">
      <div style="display: flex; align-items: center; gap: 16px;">
        <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <nav class="breadcrumb">
          <span>Banco de Dados</span>
          <i class="fas fa-chevron-right"></i>
          <span>Histórico</span>
        </nav>
      </div>
      <div class="header-actions">
        <div class="user-menu">
          <div class="user-avatar">AD</div>
          <div class="user-info"><span class="user-name">Administrador</span><span class="user-role">SIGEF</span></div>
        </div>
      </div>
    </header>
    <section class="page-header">
      <div class="page-header-content">
        <h1 class="page-title"><i class="fas fa-history"></i> Histórico de Importações</h1>
        <p class="page-subtitle">Acompanhe todas as importações de dados realizadas no sistema</p>
      </div>
    </section>
    <main class="content-area">

      <!-- Card Última Importação -->
      <div class="ultima-importacao-card" id="ultimaImportacaoCard">
        <i class="fas fa-clock icone"></i>
        <h2>Última Importação</h2>
        <div class="sem-dados" id="semUltimaImportacao">
          <i class="fas fa-inbox"></i> Nenhuma importação realizada ainda
        </div>
        <div id="dadosUltimaImportacao" style="display: none;">
          <div class="data-principal" id="ultimaData">--</div>
          <div class="detalhes" id="ultimaDetalhes">--</div>
        </div>
      </div>

      <!-- Estatísticas Resumidas -->
      <div class="stats-resumo">
        <div class="stat-mini despesas">
          <i class="fas fa-file-invoice-dollar"></i>
          <div class="valor" id="totalDespesas">0</div>
          <div class="label">Importações de Despesas</div>
        </div>
        <div class="stat-mini receitas">
          <i class="fas fa-coins"></i>
          <div class="valor" id="totalReceitas">0</div>
          <div class="label">Importações de Receitas</div>
        </div>
        <div class="stat-mini total">
          <i class="fas fa-database"></i>
          <div class="valor" id="totalGeral">0</div>
          <div class="label">Total de Importações</div>
        </div>
      </div>

      <!-- Card com Lista de Histórico -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-list"></i> Histórico Completo</h2>
          <div class="card-actions" style="display: flex; gap: 8px;">
            <button class="btn btn-secondary btn-sm" onclick="recarregarHistorico()" title="Recarregar histórico">
              <i class="fas fa-sync-alt"></i> Atualizar
            </button>
            <button class="btn btn-limpar btn-sm" onclick="limparHistorico()" id="btnLimpar" style="display: none;">
              <i class="fas fa-trash"></i> Limpar
            </button>
          </div>
        </div>
        <div class="card-body">
          
          <!-- Lista de Histórico -->
          <div class="historico-lista" id="historicoLista">
            <div class="sem-historico" id="semHistorico">
              <i class="fas fa-inbox"></i>
              <h3>Nenhuma importação registrada</h3>
              <p>Quando você importar dados, o histórico aparecerá aqui.</p>
              <a href="banco-importar-dados.html" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-file-import"></i> Importar Dados
              </a>
            </div>
          </div>

        </div>
      </div>

    </main>
    <footer class="main-footer">
      <div class="footer-content">
        <p class="footer-text">© 2026 Prefeitura Municipal de Caruaru - SIGEF. Todos os direitos reservados.</p>
      </div>
    </footer>
  </div>

  <script src="js/portal-transparencia.js"></script>
  <script>
    // =====================================================
    // HISTÓRICO DE IMPORTAÇÕES - VERSÃO SIMPLIFICADA
    // =====================================================
    
    // Chave FIXA do localStorage para o histórico
    const CHAVE_HISTORICO = 'historico-importacoes';

    // Carregar histórico ao iniciar
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== PÁGINA DE HISTÓRICO CARREGADA ===');
      console.log('Chave do localStorage:', CHAVE_HISTORICO);
      
      // Verificar conteúdo bruto do localStorage
      const dadosBrutos = localStorage.getItem(CHAVE_HISTORICO);
      console.log('Dados brutos do localStorage:', dadosBrutos);
      
      // Verificar todas as chaves do localStorage
      console.log('Todas as chaves no localStorage:');
      for (let i = 0; i < localStorage.length; i++) {
        const chave = localStorage.key(i);
        console.log(`  - ${chave}`);
      }
      
      carregarHistoricoUI();
    });

    // Carregar e exibir histórico na interface
    function carregarHistoricoUI() {
      console.log('Carregando histórico para a interface...');
      const historico = obterHistorico();
      console.log('Histórico obtido:', historico);
      console.log('Total de registros:', historico.length);
      
      // Atualizar estatísticas
      const despesas = historico.filter(h => h.tipo && h.tipo.includes('despesas')).length;
      const receitas = historico.filter(h => h.tipo && h.tipo.includes('receitas')).length;
      
      console.log('Despesas:', despesas, 'Receitas:', receitas);
      
      document.getElementById('totalDespesas').textContent = despesas;
      document.getElementById('totalReceitas').textContent = receitas;
      document.getElementById('totalGeral').textContent = historico.length;

      // Verificar se há histórico
      if (historico.length === 0) {
        document.getElementById('semHistorico').style.display = 'block';
        document.getElementById('btnLimpar').style.display = 'none';
        return;
      }

      // Esconder mensagem de sem histórico e mostrar botão limpar
      document.getElementById('semHistorico').style.display = 'none';
      document.getElementById('btnLimpar').style.display = 'inline-flex';

      // Exibir última importação
      const ultima = historico[0];
      document.getElementById('semUltimaImportacao').style.display = 'none';
      document.getElementById('dadosUltimaImportacao').style.display = 'block';
      document.getElementById('ultimaData').textContent = formatarDataCompleta(ultima.dataHora);
      document.getElementById('ultimaDetalhes').textContent = `${ultima.descricao} - ${ultima.registros.toLocaleString()} registros`;

      // Renderizar lista de histórico
      renderizarHistorico(historico);
    }

    // Obter histórico do localStorage
    function obterHistorico() {
      try {
        const dados = localStorage.getItem(CHAVE_HISTORICO);
        console.log('obterHistorico - dados brutos:', dados);
        const parsed = dados ? JSON.parse(dados) : [];
        console.log('obterHistorico - parsed:', parsed);
        return parsed;
      } catch (e) {
        console.error('Erro ao ler histórico:', e);
        return [];
      }
    }

    // Renderizar lista de histórico
    function renderizarHistorico(historico) {
      const container = document.getElementById('historicoLista');
      
      // Limpar conteúdo anterior (exceto o aviso de sem histórico)
      const semHistorico = document.getElementById('semHistorico');
      container.innerHTML = '';
      container.appendChild(semHistorico);

      // Criar itens do histórico
      historico.forEach((item, index) => {
        const tipoClasse = item.tipo.includes('despesas') ? 'despesas' : 'receitas';
        const icone = item.tipo.includes('despesas') ? 'fa-file-invoice-dollar' : 'fa-coins';
        
        const itemHtml = `
          <div class="historico-item">
            <div class="icone-tipo ${tipoClasse}">
              <i class="fas ${icone}"></i>
            </div>
            <div class="info">
              <h4>${item.descricao}</h4>
              <p>${item.arquivo || 'Arquivo não especificado'}</p>
            </div>
            <div class="registros">
              ${item.registros.toLocaleString()} registros
            </div>
            <div class="data-hora">
              <div class="data">${formatarData(item.dataHora)}</div>
              <div class="hora">${formatarHora(item.dataHora)}</div>
            </div>
          </div>
        `;
        
        container.insertAdjacentHTML('beforeend', itemHtml);
      });
    }

    // Formatar data completa
    function formatarDataCompleta(dataString) {
      const data = new Date(dataString);
      const opcoes = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      return data.toLocaleDateString('pt-BR', opcoes);
    }

    // Formatar data curta
    function formatarData(dataString) {
      const data = new Date(dataString);
      return data.toLocaleDateString('pt-BR');
    }

    // Formatar hora
    function formatarHora(dataString) {
      const data = new Date(dataString);
      return data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }

    // Limpar histórico
    function limparHistorico() {
      if (confirm('Tem certeza que deseja limpar todo o histórico de importações?\n\nEsta ação não pode ser desfeita.')) {
        localStorage.removeItem(CHAVE_HISTORICO);
        
        // Resetar interface
        document.getElementById('semHistorico').style.display = 'block';
        document.getElementById('btnLimpar').style.display = 'none';
        document.getElementById('semUltimaImportacao').style.display = 'block';
        document.getElementById('dadosUltimaImportacao').style.display = 'none';
        document.getElementById('totalDespesas').textContent = '0';
        document.getElementById('totalReceitas').textContent = '0';
        document.getElementById('totalGeral').textContent = '0';
        
        // Remover itens da lista
        const container = document.getElementById('historicoLista');
        const itens = container.querySelectorAll('.historico-item');
        itens.forEach(item => item.remove());
        
        alert('Histórico limpo com sucesso!');
      }
    }

    // Função para registrar importação (chamada pela página de importar)
    // Esta função pode ser chamada de outras páginas usando:
    // localStorage (o histórico é compartilhado)
    function registrarImportacao(tipo, descricao, registros, arquivo) {
      const historico = obterHistorico();
      
      const novoRegistro = {
        id: Date.now(),
        tipo: tipo,
        descricao: descricao,
        registros: registros,
        arquivo: arquivo,
        dataHora: new Date().toISOString()
      };
      
      // Adicionar no início (mais recente primeiro)
      historico.unshift(novoRegistro);
      
      // Manter apenas os últimos 100 registros
      if (historico.length > 100) {
        historico.pop();
      }
      
      localStorage.setItem(CHAVE_HISTORICO, JSON.stringify(historico));
      
      return novoRegistro;
    }

    // Expor função globalmente para uso em outras páginas
    window.registrarImportacao = registrarImportacao;
    
    // Recarregar histórico (atualizar interface)
    function recarregarHistorico() {
      console.log('=== RECARREGANDO HISTÓRICO ===');
      
      // Mostrar dados brutos
      const dadosBrutos = localStorage.getItem(CHAVE_HISTORICO);
      console.log('Dados brutos:', dadosBrutos);
      
      if (!dadosBrutos || dadosBrutos === '[]' || dadosBrutos === 'null') {
        alert('Nenhum histórico encontrado no localStorage.\n\nChave: ' + CHAVE_HISTORICO + '\nValor: ' + (dadosBrutos || 'vazio'));
      } else {
        const historico = JSON.parse(dadosBrutos);
        alert('Histórico encontrado!\n\nTotal de registros: ' + historico.length + '\n\nÚltimo registro:\n' + (historico[0] ? historico[0].descricao + ' - ' + historico[0].registros + ' registros' : 'Nenhum'));
      }
      
      carregarHistoricoUI();
    }
  </script>
</body>
</html>
